# 地圖顯示問題修復報告

## 問題描述

在「選擇服務位置」功能中，某些地址會導致 Google Maps 地圖無法正常顯示或顯示錯誤位置。

## 問題原因

1. **地理編碼失敗處理不足**：當 Google Maps Geocoding API 無法找到某些地址時，沒有適當的錯誤處理和用戶反饋
2. **搜尋策略有限**：原本只有3種搜尋策略，對於複雜的香港地址（包含樓層、座號等）可能無法正確定位
3. **無視覺反饋**：用戶不知道地址是否成功定位，或為什麼地圖顯示在錯誤的位置

## 修復內容

### 1. 增強地理編碼搜尋策略

**修改檔案：**
- `app/clients/new/page.tsx`
- `app/clients/edit-client/edit/page.tsx`

**改進項目：**

#### 原本的搜尋策略（3種）：
```javascript
const searchStrategies = [
  address + ', 香港',
  address,
  address + ', Hong Kong',
]
```

#### 新的搜尋策略（5種）：
```javascript
const searchStrategies = [
  address + ', 香港',                      // 完整地址 + 香港
  address + ', Hong Kong',                 // 完整地址 + Hong Kong
  address,                                  // 只用地址
  address.replace(/[樓層座]/g, '') + ', 香港',  // 移除樓層資訊再試
  address.split(',')[0] + ', 香港',         // 只用第一部分地址
]
```

### 2. 添加詳細的控制台日誌

```javascript
console.log('🗺️ 開始地址地理編碼:', address)
console.log(`🔍 嘗試策略 ${attemptCount}:`, searchStrategies[index])
console.log(`📍 策略 ${attemptCount} 結果:`, status, results)
```

這些日誌幫助開發人員和技術支援人員診斷地址定位問題。

### 3. 成功定位的視覺反饋

當地址成功定位時，在地圖上顯示綠色的成功訊息：

```
✓ 已定位到此地址
```

訊息會在2秒後自動消失。

### 4. 失敗情況的明確提示

當所有策略都失敗時，在地圖上顯示詳細的錯誤訊息：

```
⚠️ 無法定位地址
系統無法找到此地址：
[顯示具體地址]
請在地圖上手動點擊選擇正確位置，或檢查地址是否正確。
```

訊息會在5秒後自動消失。

### 5. 改進的錯誤處理邏輯

```javascript
const tryGeocode = (index: number) => {
  if (index >= searchStrategies.length) {
    // 所有策略都失敗
    if (!foundLocation) {
      console.warn('⚠️ 所有地理編碼策略都失敗，地圖將顯示在香港中心位置')
      // 顯示提示訊息給用戶
    }
    return
  }
  // ... 繼續嘗試下一個策略
}
```

## 修復效果

### 之前：
- ❌ 某些地址導致地圖完全不顯示
- ❌ 沒有錯誤提示，用戶不知道發生了什麼問題
- ❌ 無法處理複雜的香港地址格式

### 之後：
- ✅ 地圖總是會顯示（即使地址無法定位也會顯示在香港中心）
- ✅ 明確的成功/失敗訊息提示用戶
- ✅ 增加的搜尋策略提高定位成功率
- ✅ 詳細的控制台日誌方便問題診斷
- ✅ 失敗時引導用戶手動選擇位置

## 測試建議

### 1. 測試各種地址格式

建議測試以下類型的地址：

1. **標準地址**：
   - `九龍旺角彌敦道123號`
   - `香港中環皇后大道中456號`

2. **包含樓層的地址**：
   - `新界荃灣青山道789號10樓A座`
   - `九龍觀塘開源道111號12樓B室`

3. **簡化地址**：
   - `旺角彌敦道`
   - `銅鑼灣時代廣場`

4. **英文地址**：
   - `123 Nathan Road, Mong Kok`
   - `456 Queen's Road Central, Hong Kong`

5. **可能有問題的地址**：
   - 非常新的建築物
   - 村屋地址
   - 工業大廈
   - 臨時地址

### 2. 檢查項目

- [ ] 地圖是否總是能夠顯示
- [ ] 成功定位時是否顯示綠色確認訊息
- [ ] 失敗時是否顯示警告訊息
- [ ] 警告訊息是否包含正確的地址
- [ ] 用戶是否能夠手動點擊地圖選擇位置
- [ ] 控制台是否輸出詳細的日誌資訊

### 3. 控制台日誌檢查

打開瀏覽器開發者工具（F12），查看控制台輸出：

**成功案例應顯示：**
```
🗺️ 開始地址地理編碼: [地址]
🔍 嘗試策略 1: [地址], 香港
📍 策略 1 結果: OK [結果物件]
✅ 成功定位地址: {lat: ..., lng: ...}
```

**失敗案例應顯示：**
```
🗺️ 開始地址地理編碼: [地址]
🔍 嘗試策略 1: [地址], 香港
📍 策略 1 結果: ZERO_RESULTS
⚠️ 策略 1 失敗，嘗試下一個策略
🔍 嘗試策略 2: [地址], Hong Kong
📍 策略 2 結果: ZERO_RESULTS
⚠️ 策略 2 失敗，嘗試下一個策略
... (重複直到所有策略)
⚠️ 所有地理編碼策略都失敗，地圖將顯示在香港中心位置
```

## 後續優化建議

1. **地址資料庫**：建立常用地址的緩存資料庫，減少 Geocoding API 調用
2. **用戶回饋機制**：允許用戶報告地址定位問題，收集無法定位的地址以改進系統
3. **地址建議**：整合 Google Places Autocomplete API，在用戶輸入時提供地址建議
4. **離線地圖**：考慮為常用區域提供離線地圖支援
5. **座標驗證**：添加座標合理性檢查，確保定位結果在香港範圍內

## 相關檔案

- `app/clients/new/page.tsx` - 新增客戶頁面
- `app/clients/edit-client/edit/page.tsx` - 編輯客戶頁面

## 修復日期

2025年10月13日

## 修復人員

GitHub Copilot
