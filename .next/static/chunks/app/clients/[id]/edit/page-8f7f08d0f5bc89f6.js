(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[953],{7180:function(e,t,a){Promise.resolve().then(a.bind(a,6130))},6130:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return o}});var s=a(7437),r=a(2265),l=a(9376),i=a(2141),n=a(8478);function o(e){let{params:t}=e,[a,o]=(0,r.useState)(null),[c,d]=(0,r.useState)(!0),[u,p]=(0,r.useState)(!1),[m,h]=(0,r.useState)(""),[x,v]=(0,r.useState)(""),[_,j]=(0,r.useState)(!1),[g,y]=(0,r.useState)(!1),[b,f]=(0,r.useState)(!1),[N,k]=(0,r.useState)({customer_type:"社區券客戶",customer_name:"",service_address:"",charity_support:!1}),[w,C]=(0,r.useState)({}),I=(0,l.useRouter)();(0,r.useEffect)(()=>{(async()=>{let{data:{user:e}}=await i.O.auth.getUser();e?(o(e),await S()):I.push("/"),d(!1)})()},[I]);let S=async()=>{try{let e=await n.n.getCustomerById(t.id);if(e.error){console.error("API Error:",e.error),C({general:e.error});return}if(e.data){let t=e.data;h(t.customer_id||"");let a={customer_type:t.customer_type,customer_name:t.customer_name,service_address:t.service_address,phone:t.phone||"",hkid:t.hkid||"",dob:t.dob||"",age:t.age||void 0,district:t.district,health_status:t.health_status,introducer:t.introducer,voucher_number:t.voucher_number||"",charity_support:t.charity_support||!1,voucher_application_status:t.voucher_application_status,lds_status:t.lds_status,home_visit_status:t.home_visit_status,staff_owner:t.project_manager,copay_level:t.copay_level};k(a)}else C({general:"找不到客戶資料"})}catch(e){console.error("Failed to load customer:",e),C({general:"載入客戶資料失敗"})}},D=async()=>{try{if(!("明家街客"===N.customer_type||"社區券客戶"===N.customer_type&&"已經持有"===N.voucher_application_status)||!N.introducer){v(""),y(!1);return}let e=await n.n.generateNextCustomerId(N.customer_type,N.introducer);if(q(m,e)){v(""),y(!1),console.log("編號類型相同，不提示用戶選擇:",m,"→",e);return}v(e),y(!0),C(e=>({...e,customerIdGeneration:"",general:""}))}catch(e){console.error("自動生成客戶編號失敗:",e),C(t=>({...t,customerIdGeneration:e.message||"生成客戶編號失敗"})),v(""),y(!1)}},q=(e,t)=>{if(!e||!t)return!1;let a=e=>e.startsWith("S-CCSV")?"steven-community-voucher":e.startsWith("CCSV-MC")?"community-voucher":e.startsWith("MC")&&/^MC\d+$/.test(e)?"mingcare-direct":"unknown",s=a(e),r=a(t);return console.log("編號類型比較:",{original:{id:e,type:s},new:{id:t,type:r},isSame:s===r&&"unknown"!==s}),s===r&&"unknown"!==s};(0,r.useEffect)(()=>{b&&N.customer_type&&N.introducer&&D()},[N.customer_type,N.introducer,N.voucher_application_status,b]);let M=e=>{if(!e)return;let t=new Date(e),a=new Date,s=a.getFullYear()-t.getFullYear(),r=a.getMonth()-t.getMonth();return(r<0||0===r&&a.getDate()<t.getDate())&&s--,s>=0?s:void 0},O=(e,t)=>{("customer_type"===e||"introducer"===e||"voucher_application_status"===e)&&f(!0),k(a=>{let s={...a,[e]:t};return"dob"===e&&(s.age=M(t)),_&&("customer_type"===e&&("明家街客"===t?(s.voucher_application_status=void 0,s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0,s.home_visit_status=void 0):"社區券客戶"===t&&(s.voucher_application_status=void 0,s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0,s.home_visit_status=void 0)),"voucher_application_status"===e&&("已經持有"===t?s.lds_status="已經持有":"申請中"===t?(s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0):(s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0,s.home_visit_status=void 0)),"copay_level"===e&&"5%"!==t&&(s.charity_support=void 0)),s}),w[e]&&C(t=>{let a={...t};return delete a[e],a})},L=()=>{var e,t,a;let s={};return(null===(e=N.customer_name)||void 0===e?void 0:e.trim())||(s.customer_name="請輸入客戶姓名"),(null===(t=N.service_address)||void 0===t?void 0:t.trim())||(s.service_address="請輸入服務地址"),_&&"社區券客戶"===N.customer_type&&(N.voucher_application_status||(s.voucher_application_status="請選擇社區券申請狀況"),"已經持有"===N.voucher_application_status&&((null===(a=N.voucher_number)||void 0===a?void 0:a.trim())||(s.voucher_number="請輸入社區券號碼"),N.copay_level||(s.copay_level="請選擇自付比例等級"),"5%"===N.copay_level&&void 0===N.charity_support&&(s.charity_support="請選擇是否需要慈善機構贊助")),"申請中"!==N.voucher_application_status&&"已經持有"!==N.voucher_application_status||(N.lds_status||(s.lds_status="請選擇LDS狀況"),N.home_visit_status||(s.home_visit_status="請選擇家訪狀況"))),C(s),0===Object.keys(s).length},J=async e=>{if(e.preventDefault(),L()){p(!0);try{let e;if(N.dob){let t=new Date(N.dob),a=new Date;e=a.getFullYear()-t.getFullYear();let s=a.getMonth()-t.getMonth();(s<0||0===s&&a.getDate()<t.getDate())&&e--}let a={...N,age:e||N.age,customer_id:_?x:m},s=await n.n.updateCustomer(t.id,a);s.error?C({general:s.error}):I.push("/clients")}catch(e){console.error("Failed to update customer:",e),C({general:e.message||"更新客戶資料失敗"})}finally{p(!1)}}},E=async()=>{if(window.confirm("確定要刪除客戶「".concat(N.customer_name,"」嗎？\n\n此操作無法復原，將永久刪除所有相關資料。"))){p(!0);try{let e=await n.n.deleteCustomer(t.id);e.error?C({general:e.error}):I.push("/clients")}catch(e){console.error("Failed to delete customer:",e),C({general:e.message||"刪除客戶失敗"})}finally{p(!1)}}};return c?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-bg-primary",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-2 border-mingcare-blue border-t-transparent"}),(0,s.jsx)("p",{className:"text-apple-body text-text-secondary mt-4",children:"載入中..."})]})}):(0,s.jsxs)("div",{className:"min-h-screen bg-bg-primary",children:[(0,s.jsx)("header",{className:"card-apple border-b border-border-light fade-in-apple",children:(0,s.jsx)("div",{className:"max-w-4xl mx-auto px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"flex justify-between items-center py-8",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-apple-title text-text-primary mb-2",children:"編輯客戶資料"}),(0,s.jsx)("p",{className:"text-apple-body text-text-secondary",children:"更新客戶的基本資料和服務資訊"})]}),(0,s.jsxs)("button",{onClick:()=>I.push("/clients"),className:"btn-apple-secondary",children:[(0,s.jsx)("svg",{className:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"返回客戶列表"]})]})})}),(0,s.jsx)("main",{className:"max-w-4xl mx-auto py-8 px-6 lg:px-8",children:(0,s.jsxs)("form",{onSubmit:J,className:"space-y-8",children:[w.general&&(0,s.jsx)("div",{className:"card-apple border-danger bg-danger-light fade-in-apple",children:(0,s.jsx)("div",{className:"card-apple-content",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("svg",{className:"h-5 w-5 text-danger mr-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,s.jsx)("p",{className:"text-apple-body text-danger",children:w.general})]})})}),(0,s.jsx)("div",{className:"card-apple fade-in-apple",children:(0,s.jsxs)("div",{className:"card-apple-content",children:[(0,s.jsx)("h2",{className:"text-apple-heading text-text-primary mb-6",children:"客戶編號管理"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"客戶編號"}),(0,s.jsx)("input",{type:"text",value:_?x:m,readOnly:!0,className:"form-input-apple bg-bg-secondary w-full",placeholder:"載入中..."}),m&&!_&&(0,s.jsxs)("p",{className:"text-apple-caption text-text-secondary mt-2",children:["目前使用：",m]}),_&&x&&(0,s.jsxs)("p",{className:"text-apple-caption text-success mt-2",children:["✓ 將使用新編號：",x]})]}),g&&x&&(0,s.jsx)("div",{className:"bg-bg-tertiary rounded-apple-sm p-4 border border-border-light",children:(0,s.jsxs)("div",{className:"flex items-start space-x-3 mb-4",children:[(0,s.jsx)("svg",{className:"h-5 w-5 text-mingcare-blue mt-0.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h3",{className:"text-apple-body font-medium text-text-primary mb-2",children:"系統偵測到可以生成新的客戶編號"}),(0,s.jsxs)("p",{className:"text-apple-caption text-text-secondary mb-4",children:["根據目前的客戶類型（",N.customer_type,"）和介紹人（",N.introducer,"）， 系統可以為此客戶生成新的編號：",(0,s.jsx)("span",{className:"font-medium text-mingcare-blue",children:x})]}),(0,s.jsxs)("div",{className:"flex space-x-3",children:[(0,s.jsxs)("button",{type:"button",onClick:()=>{j(!1),y(!1),f(!1)},className:"btn-apple-secondary text-sm",children:["保留原編號（",m,"）"]}),(0,s.jsxs)("button",{type:"button",onClick:()=>{j(!0),y(!1),f(!1)},className:"btn-apple-primary text-sm",children:["使用新編號（",x,"）"]})]})]})]})}),w.customerIdGeneration&&(0,s.jsx)("div",{className:"bg-danger-light border border-danger rounded-apple-sm p-3",children:(0,s.jsx)("p",{className:"text-apple-caption text-danger",children:w.customerIdGeneration})})]})]})}),(0,s.jsx)("div",{className:"card-apple fade-in-apple",children:(0,s.jsxs)("div",{className:"card-apple-content",children:[(0,s.jsx)("h2",{className:"text-apple-heading text-text-primary mb-6",children:"基礎資訊"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["客戶類型 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:N.customer_type,onChange:e=>O("customer_type",e.target.value),className:"form-input-apple",required:!0,children:[(0,s.jsx)("option",{value:"社區券客戶",children:"社區券客戶"}),(0,s.jsx)("option",{value:"明家街客",children:"明家街客"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["介紹人 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:N.introducer||"",onChange:e=>O("introducer",e.target.value),className:"form-input-apple",required:!0,children:[(0,s.jsx)("option",{value:"",children:"請選擇介紹人"}),(0,s.jsx)("option",{value:"Kanas Leung",children:"Kanas Leung"}),(0,s.jsx)("option",{value:"Joe Cheung",children:"Joe Cheung"}),(0,s.jsx)("option",{value:"Candy Ho",children:"Candy Ho"}),(0,s.jsx)("option",{value:"Steven Kwok",children:"Steven Kwok"}),(0,s.jsx)("option",{value:"Dr.Lee",children:"Dr.Lee"}),(0,s.jsx)("option",{value:"Annie",children:"Annie"}),(0,s.jsx)("option",{value:"Janet",children:"Janet"}),(0,s.jsx)("option",{value:"陸sir",children:"陸sir"}),(0,s.jsx)("option",{value:"吳翹政",children:"吳翹政"}),(0,s.jsx)("option",{value:"余翠英",children:"余翠英"}),(0,s.jsx)("option",{value:"陳小姐MC01",children:"陳小姐MC01"}),(0,s.jsx)("option",{value:"曾先生",children:"曾先生"})]}),_&&(0,s.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"請先選擇介紹人，確定後才會生成客戶編號"})]})]}),"社區券客戶"===N.customer_type&&(0,s.jsxs)("div",{className:"mt-6 pt-6 border-t border-border-primary",children:[(0,s.jsx)("h3",{className:"text-apple-body font-semibold text-text-primary mb-4",children:"社區券資訊"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["申請狀況 ",_&&(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:N.voucher_application_status||"",onChange:e=>O("voucher_application_status",e.target.value),className:"form-input-apple ".concat(w.voucher_application_status?"border-danger":""),required:_,children:[(0,s.jsx)("option",{value:"",children:"請選擇申請狀況"}),(0,s.jsx)("option",{value:"已經持有",children:"已經持有"}),(0,s.jsx)("option",{value:"申請中",children:"申請中"})]}),w.voucher_application_status&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.voucher_application_status}),_&&"申請中"===N.voucher_application_status&&(0,s.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"申請中狀態不會生成客戶編號"})]}),(!_||"申請中"===N.voucher_application_status||"已經持有"===N.voucher_application_status)&&(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["LDS 狀態 ",_&&(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:N.lds_status||"",onChange:e=>O("lds_status",e.target.value),className:"form-input-apple ".concat(w.lds_status?"border-danger":""),disabled:_&&"已經持有"===N.voucher_application_status,required:_,children:[(0,s.jsx)("option",{value:"",children:"請選擇 LDS 狀態"}),(0,s.jsx)("option",{value:"已完成評估",children:"已完成評估"}),(0,s.jsx)("option",{value:"已經持有",children:"已經持有"}),(0,s.jsx)("option",{value:"待社工評估",children:"待社工評估"})]}),_&&"已經持有"===N.voucher_application_status&&(0,s.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"已自動設為「已經持有」"}),w.lds_status&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.lds_status})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["家訪狀況 ",_&&(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:N.home_visit_status||"",onChange:e=>O("home_visit_status",e.target.value),className:"form-input-apple ".concat(w.home_visit_status?"border-danger":""),required:_,children:[(0,s.jsx)("option",{value:"",children:"請選擇家訪狀況"}),(0,s.jsx)("option",{value:"已完成",children:"已完成"}),(0,s.jsx)("option",{value:"未完成",children:"未完成"})]}),w.home_visit_status&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.home_visit_status})]})]}),(!_||"已經持有"===N.voucher_application_status)&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["社區券號碼 ",_&&(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsx)("input",{type:"text",value:N.voucher_number||"",onChange:e=>O("voucher_number",e.target.value),className:"form-input-apple ".concat(w.voucher_number?"border-danger":""),placeholder:"請輸入社區券號碼",required:_}),w.voucher_number&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.voucher_number})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["自付額 ",_&&(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:N.copay_level||"",onChange:e=>O("copay_level",e.target.value),className:"form-input-apple ".concat(w.copay_level?"border-danger":""),required:_,children:[(0,s.jsx)("option",{value:"",children:"請選擇自付額"}),(0,s.jsx)("option",{value:"5%",children:"5%"}),(0,s.jsx)("option",{value:"8%",children:"8%"}),(0,s.jsx)("option",{value:"12%",children:"12%"}),(0,s.jsx)("option",{value:"16%",children:"16%"}),(0,s.jsx)("option",{value:"25%",children:"25%"}),(0,s.jsx)("option",{value:"40%",children:"40%"})]}),w.copay_level&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.copay_level})]})]}),(!_||"5%"===N.copay_level)&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["慈善補助 ",_&&"5%"===N.copay_level&&(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("div",{className:"flex space-x-4 mt-2",children:[(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"radio",name:"charity_support",value:"true",checked:!0===N.charity_support,onChange:e=>O("charity_support","true"===e.target.value),className:"w-4 h-4 text-mingcare-blue focus:ring-mingcare-blue"}),(0,s.jsx)("span",{className:"ml-2 text-apple-caption",children:"是"})]}),(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"radio",name:"charity_support",value:"false",checked:!1===N.charity_support,onChange:e=>O("charity_support","false"===e.target.value),className:"w-4 h-4 text-mingcare-blue focus:ring-mingcare-blue"}),(0,s.jsx)("span",{className:"ml-2 text-apple-caption",children:"否"})]})]}),w.charity_support&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.charity_support})]})]})]})]})]})}),(0,s.jsx)("div",{className:"card-apple fade-in-apple",children:(0,s.jsxs)("div",{className:"card-apple-content",children:[(0,s.jsx)("h2",{className:"text-apple-heading text-text-primary mb-6",children:"個人資訊"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["客戶姓名 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsx)("input",{type:"text",value:N.customer_name||"",onChange:e=>O("customer_name",e.target.value),className:"form-input-apple ".concat(w.customer_name?"border-danger":""),placeholder:"請輸入客戶姓名",required:!0}),w.customer_name&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.customer_name})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"電話號碼"}),(0,s.jsx)("input",{type:"tel",value:N.phone||"",onChange:e=>O("phone",e.target.value),className:"form-input-apple",placeholder:"請輸入電話號碼"})]}),(0,s.jsxs)("div",{className:"md:col-span-2",children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["服務地址 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsx)("input",{type:"text",value:N.service_address||"",onChange:e=>O("service_address",e.target.value),className:"form-input-apple ".concat(w.service_address?"border-danger":""),placeholder:"請輸入完整服務地址",required:!0}),w.service_address&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:w.service_address})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"地區"}),(0,s.jsxs)("select",{value:N.district||"",onChange:e=>O("district",e.target.value),className:"form-input-apple",children:[(0,s.jsx)("option",{value:"",children:"請選擇地區"}),(0,s.jsx)("option",{value:"中西區",children:"中西區"}),(0,s.jsx)("option",{value:"九龍城區",children:"九龍城區"}),(0,s.jsx)("option",{value:"元朗區",children:"元朗區"}),(0,s.jsx)("option",{value:"北區",children:"北區"}),(0,s.jsx)("option",{value:"南區",children:"南區"}),(0,s.jsx)("option",{value:"大埔區",children:"大埔區"}),(0,s.jsx)("option",{value:"屯門區",children:"屯門區"}),(0,s.jsx)("option",{value:"東區",children:"東區"}),(0,s.jsx)("option",{value:"沙田區",children:"沙田區"}),(0,s.jsx)("option",{value:"油尖旺區",children:"油尖旺區"}),(0,s.jsx)("option",{value:"深水埗區",children:"深水埗區"}),(0,s.jsx)("option",{value:"灣仔區",children:"灣仔區"}),(0,s.jsx)("option",{value:"荃灣區",children:"荃灣區"}),(0,s.jsx)("option",{value:"葵青區",children:"葵青區"}),(0,s.jsx)("option",{value:"西貢區",children:"西貢區"}),(0,s.jsx)("option",{value:"觀塘區",children:"觀塘區"}),(0,s.jsx)("option",{value:"離島區",children:"離島區"}),(0,s.jsx)("option",{value:"黃大仙區",children:"黃大仙區"}),(0,s.jsx)("option",{value:"未分類（醫院,院舍)",children:"未分類（醫院,院舍)"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"身份證號碼"}),(0,s.jsx)("input",{type:"text",value:N.hkid||"",onChange:e=>O("hkid",e.target.value),className:"form-input-apple",placeholder:"請輸入身份證號碼"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"出生日期"}),(0,s.jsx)("input",{type:"date",value:N.dob||"",onChange:e=>O("dob",e.target.value),className:"form-input-apple"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"年齡"}),(0,s.jsx)("input",{type:"number",value:N.age||"",readOnly:!0,className:"form-input-apple bg-bg-secondary",placeholder:"系統自動計算"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"健康狀況"}),(0,s.jsxs)("select",{value:N.health_status||"",onChange:e=>O("health_status",e.target.value),className:"form-input-apple",children:[(0,s.jsx)("option",{value:"",children:"請選擇健康狀況"}),(0,s.jsx)("option",{value:"良好",children:"良好"}),(0,s.jsx)("option",{value:"中風",children:"中風"}),(0,s.jsx)("option",{value:"需協助",children:"需協助"}),(0,s.jsx)("option",{value:"長期病患",children:"長期病患"}),(0,s.jsx)("option",{value:"認知障礙",children:"認知障礙"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"負責職員"}),(0,s.jsxs)("select",{value:N.staff_owner||"",onChange:e=>O("staff_owner",e.target.value),className:"form-input-apple",children:[(0,s.jsx)("option",{value:"",children:"請選擇負責職員"}),(0,s.jsx)("option",{value:"Kanas Leung",children:"Kanas Leung"}),(0,s.jsx)("option",{value:"Joe Cheung",children:"Joe Cheung"}),(0,s.jsx)("option",{value:"Candy Ho",children:"Candy Ho"})]})]})]})]})}),(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("button",{type:"button",onClick:E,className:"btn-apple-danger",children:"刪除客戶"}),(0,s.jsxs)("div",{className:"flex space-x-4",children:[(0,s.jsx)("button",{type:"button",onClick:()=>I.push("/clients"),className:"btn-apple-secondary",children:"取消"}),(0,s.jsx)("button",{type:"submit",disabled:u,className:"btn-apple-primary",children:u?(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"}),"保存中..."]}):"保存變更"})]})]})]})})]})}},2141:function(e,t,a){"use strict";a.d(t,{O:function(){return s}});let s=(0,a(3960).AY)("https://cvkxlvdicympakfecgvv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3hsdmRpY3ltcGFrZmVjZ3Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MjkxODEsImV4cCI6MjA2NzAwNTE4MX0.jp2fPKcBcG4-042UoN3OieR553WAgABhJIujiDJAt-I")},8478:function(e,t,a){"use strict";a.d(t,{n:function(){return r}});var s=a(2141);class r{static isUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)}static async queryBySmartId(e,t){let a=this.isUUID(e),r=a?"id":"customer_id";return console.log("Using ".concat(r," query for ").concat(a?"UUID":"customer number",":"),e),t(s.O.from("customer_personal_data"),r)}static async generateNextCustomerId(e,t){try{let{data:a,error:r}=await s.O.rpc("generate_next_customer_id",{p_customer_type:e,p_introducer:t||null});if(r)throw console.error("RPC 錯誤:",r),Error("生成客戶編號失敗: ".concat(r.message));if(!a)throw Error("RPC 未返回編號");return a}catch(e){throw console.error("生成客戶編號失敗:",e),Error("生成客戶編號失敗: ".concat(e.message||"未知錯誤"))}}static async getSearchSuggestions(e){try{if(e.query.length<2)return{data:[],error:"請輸入至少 2 個字元後再搜尋"};let t=e.query.trim(),a=e.limit||10,{data:r,error:l}=await s.O.from("customer_personal_data").select("id, customer_id, customer_name, phone").or("customer_name.ilike.%".concat(t,"%,phone.ilike.%").concat(t,"%,customer_id.ilike.%").concat(t,"%")).order("created_at",{ascending:!1}).limit(a);if(l)throw l;return{data:(r||[]).map(e=>({id:e.id,customer_id:e.customer_id,customer_name:e.customer_name,phone:e.phone,display_text:"".concat(e.customer_name," - ").concat(e.phone).concat(e.customer_id?" - ".concat(e.customer_id):" - 未分配編號")}))}}catch(e){return{data:[],error:"搜尋建議載入失敗",message:e.message}}}static async getCustomers(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;try{let r=s.O.from("customer_personal_data").select("\n          id,\n          customer_id,\n          customer_name,\n          phone,\n          district,\n          service_address,\n          project_manager,\n          created_at,\n          customer_type,\n          voucher_application_status,\n          lds_status,\n          home_visit_status,\n          copay_level\n        ",{count:"exact"});(null==e?void 0:e.customer_type)&&(r=r.eq("customer_type",e.customer_type)),(null==e?void 0:e.district)&&(r=r.eq("district",e.district)),(null==e?void 0:e.introducer)&&(r=r.eq("introducer",e.introducer)),(null==e?void 0:e.project_manager)&&(r=r.eq("project_manager",e.project_manager)),(null==e?void 0:e.search)&&(r=r.or("customer_name.ilike.%".concat(e.search,"%,phone.ilike.%").concat(e.search,"%,customer_id.ilike.%").concat(e.search,"%")));let l=(t-1)*a;r=(r=r.range(l,l+a-1)).order("created_at",{ascending:!1});let{data:i,error:n,count:o}=await r;if(n)throw n;return{data:i||[],count:o||0,page:t,pageSize:a,totalPages:Math.ceil((o||0)/a)}}catch(e){return console.error("獲取客戶列表失敗:",e),{data:[],count:0,page:t,pageSize:a,totalPages:0}}}static async getCustomerById(e){try{console.log("Fetching customer with ID:",e);let{data:t,error:a}=await this.queryBySmartId(e,(t,a)=>t.select("*").eq(a,e).single());if(a&&"PGRST116"===a.code){console.log("First query failed, trying alternative method...");let t=this.isUUID(e),a=await s.O.from("customer_personal_data").select("*").eq(t?"customer_id":"id",e).single();if(a.error)throw console.error("Database error:",a.error),a.error;return console.log("Customer data found via alternative method:",a.data),{data:a.data||void 0}}if(a)throw console.error("Database error:",a),a;return console.log("Customer data found:",t),{data:t||void 0}}catch(e){return console.error("Service error:",e),{error:"客戶資料載入失敗",message:e.message}}}static async createCustomer(e){try{let t=await this.generateNextCustomerId(e.customer_type,e.introducer),a={customer_id:t,customer_type:e.customer_type,customer_name:e.customer_name,service_address:e.service_address,charity_support:e.charity_support||!1,phone:e.phone||null,hkid:e.hkid||null,dob:e.dob||null,age:e.age||null,district:e.district||null,health_status:e.health_status||null,introducer:e.introducer||null,voucher_application_status:e.voucher_application_status||null,lds_status:e.lds_status||null,home_visit_status:e.home_visit_status||null,project_manager:e.staff_owner||null,copay_level:e.copay_level||null,voucher_number:e.voucher_number||null,created_at:new Date().toISOString()},{error:r}=await s.O.from("customer_personal_data").insert([a]);if(r)throw console.error("Supabase 插入錯誤:",r),Error(r.message);return{success:!0,customer_id:t}}catch(e){return console.error("新增客戶失敗:",e),{success:!1,error:e.message||"新增客戶失敗"}}}static async updateCustomer(e,t){try{if(t.dob){let e=new Date(t.dob),a=new Date;t.age=a.getFullYear()-e.getFullYear();let s=a.getMonth()-e.getMonth();(s<0||0===s&&a.getDate()<e.getDate())&&t.age--}let a=await this.queryBySmartId(e,(a,s)=>a.update(t).eq(s,e).select().single());if(a.error)throw a.error;return{data:a.data||void 0}}catch(e){return{error:"客戶資料更新失敗",message:e.message}}}static async deleteCustomer(e){try{let t=await this.queryBySmartId(e,(t,a)=>t.delete().eq(a,e));if(t.error)throw t.error;return{}}catch(e){return{error:"客戶刪除失敗",message:e.message}}}static validateCustomerData(e){var t,a,s,r,l,i,n,o,c,d,u;let p={};return(null===(t=e.customer_name)||void 0===t?void 0:t.trim())||(p.customer_name="客戶姓名為必填欄位"),(null===(a=e.phone)||void 0===a?void 0:a.trim())||(p.phone="電話為必填欄位"),(null===(s=e.district)||void 0===s?void 0:s.trim())||(p.district="地區為必填欄位"),(null===(r=e.service_address)||void 0===r?void 0:r.trim())||(p.service_address="服務地址為必填欄位"),(null===(l=e.hkid)||void 0===l?void 0:l.trim())||(p.hkid="身份證號碼為必填欄位"),(null===(i=e.dob)||void 0===i?void 0:i.trim())||(p.dob="出生日期為必填欄位"),(null===(n=e.health_status)||void 0===n?void 0:n.trim())||(p.health_status="身體狀況為必填欄位"),(null===(o=e.introducer)||void 0===o?void 0:o.trim())||(p.introducer="介紹人為必填欄位"),(null===(c=e.project_manager)||void 0===c?void 0:c.trim())||(p.project_manager="項目經理為必填欄位"),e.phone&&!/^[0-9]{8}$/.test(e.phone)&&(p.phone="電話格式錯誤，請輸入 8 位數字"),e.hkid&&!/^[A-Z]{1,2}[0-9]{6}([0-9A])$/.test(e.hkid)&&(p.hkid="HKID 格式錯誤"),e.dob&&new Date(e.dob)>new Date&&(p.dob="出生日期不能是未來日期"),"已經持有"!==e.voucher_application_status||((null===(d=e.voucher_number)||void 0===d?void 0:d.trim())||(p.voucher_number="voucher_number：只有 voucher_application_status=已經持有 時必填"),(null===(u=e.copay_level)||void 0===u?void 0:u.trim())||(p.copay_level="請選擇自付比例（copay_level）")),"5%"===e.copay_level&&void 0===e.charity_support&&(p.charity_support="copay_level 為 5% 時，必須選擇慈善資助（charity_support）"),{isValid:0===Object.keys(p).length,errors:p}}}}},function(e){e.O(0,[998,971,117,744],function(){return e(e.s=7180)}),_N_E=e.O()}]);