(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[849],{3330:function(e,t,s){Promise.resolve().then(s.bind(s,1861))},1861:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return d}});var r=s(7437),a=s(2265),n=s(9376),l=s(2141),i=s(8478),o=s(4887);function c(e){let{isVisible:t,suggestions:s,onSelectSuggestion:n,onClose:l,targetRef:i}=e,c=(0,a.useRef)(null),[d,x]=(0,a.useState)({top:0,left:0,width:0}),[m,u]=(0,a.useState)(!1);(0,a.useEffect)(()=>{u(!0)},[]);let p=()=>{if(!i.current)return;let e=i.current.getBoundingClientRect(),t=window.scrollY,s=window.scrollX;x({top:e.bottom+t+2,left:e.left+s,width:e.width})};if((0,a.useEffect)(()=>{if(!t)return;p();let e=()=>p(),s=()=>p();return window.addEventListener("scroll",e),window.addEventListener("resize",s),()=>{window.removeEventListener("scroll",e),window.removeEventListener("resize",s)}},[t,i]),(0,a.useEffect)(()=>{if(!t)return;let e=e=>{var t,s;let r=e.target;(null===(t=i.current)||void 0===t?void 0:t.contains(r))||(null===(s=c.current)||void 0===s?void 0:s.contains(r))||l()};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[t,l,i]),(0,a.useEffect)(()=>{if(!t)return;let e=e=>{"Escape"===e.key&&l()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[t,l]),!m||!t||0===s.length)return null;let h=(0,r.jsx)("div",{ref:c,className:"fixed bg-white border border-border-light rounded-apple-lg shadow-apple-lg max-h-64 overflow-y-auto z-[9999]",style:{top:"".concat(d.top,"px"),left:"".concat(d.left,"px"),width:"".concat(d.width,"px"),minWidth:"300px"},children:s.map((e,t)=>(0,r.jsx)("div",{onClick:()=>n(e),className:"px-4 py-3 hover:bg-bg-secondary cursor-pointer border-b border-border-light last:border-b-0 transition-colors duration-150",children:(0,r.jsx)("div",{className:"flex items-center justify-between",children:(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("div",{className:"flex items-center space-x-3",children:(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("div",{className:"font-medium text-text-primary",children:e.customer_name}),(0,r.jsx)("div",{className:"text-sm text-text-secondary",children:e.customer_id})]})}),(0,r.jsxs)("div",{className:"text-xs text-text-tertiary mt-1",children:[e.phone&&(0,r.jsxs)("span",{className:"mr-3",children:["\uD83D\uDCDE ",e.phone]}),(0,r.jsx)("span",{className:"text-xs text-text-tertiary",children:e.display_text})]})]})})},"".concat(e.id,"-").concat(t)))});return(0,o.createPortal)(h,document.body)}function d(){let[e,t]=(0,a.useState)(null),[s,o]=(0,a.useState)(!0),[d,x]=(0,a.useState)([]),[m,u]=(0,a.useState)("card"),[p,h]=(0,a.useState)({}),[v,g]=(0,a.useState)(""),[j,y]=(0,a.useState)([]),[b,f]=(0,a.useState)(!1),[N,_]=(0,a.useState)(0),[w,k]=(0,a.useState)(1),[C]=(0,a.useState)(20),[L,M]=(0,a.useState)(null),S=(0,a.useRef)(null),D=(0,n.useRouter)();(0,a.useEffect)(()=>{(async()=>{let{data:{user:e}}=await l.O.auth.getUser();e?(t(e),await I()):D.push("/"),o(!1)})()},[D]);let I=async()=>{try{let e=await i.n.getCustomers(p,w,C);x(e.data),_(e.count)}catch(e){console.error("載入客戶列表失敗:",e)}},E=async e=>{g(e),L&&clearTimeout(L),e.length>=2?M(setTimeout(async()=>{try{let t=await i.n.getSearchSuggestions({query:e,limit:8});t.data&&(y(t.data),f(!0))}catch(e){console.error("搜尋建議失敗:",e)}},300)):(y([]),f(!1))},z=async e=>{let t=e||v;if(t.trim()){let e={...p,search:t.trim()};h(e),k(1);try{let t=await i.n.getCustomers(e,1,C);x(t.data),_(t.count)}catch(e){console.error("搜尋失敗:",e)}}};(0,a.useEffect)(()=>{e&&I()},[p,w]);let B=e=>{k(e)},W=Math.ceil(N/C),O=(w-1)*C+1,q=Math.min(w*C,N);return s?(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,r.jsx)("div",{className:"text-lg",children:"載入中..."})}):(0,r.jsxs)("div",{className:"min-h-screen bg-bg-primary",children:[(0,r.jsx)("header",{className:"card-apple border-b border-border-light fade-in-apple",children:(0,r.jsx)("div",{className:"px-4 sm:px-6 lg:px-8",children:(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center py-4 sm:py-6 lg:py-8 space-y-4 sm:space-y-0",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold text-text-primary mb-1 sm:mb-2",children:"客戶管理中心"}),(0,r.jsx)("p",{className:"text-sm sm:text-base text-text-secondary",children:"管理所有客戶資料、聯絡信息及服務記錄"})]}),(0,r.jsx)("button",{onClick:()=>D.push("/dashboard"),className:"btn-apple-secondary text-xs sm:text-sm self-start sm:self-auto",children:"返回主頁"})]})})}),(0,r.jsxs)("main",{className:"px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8",children:[(0,r.jsxs)("div",{className:"card-apple mb-4 sm:mb-6 fade-in-apple",children:[(0,r.jsx)("div",{className:"card-apple-header",children:(0,r.jsx)("h3",{className:"text-lg sm:text-xl font-semibold text-text-primary",children:"搜尋與篩選"})}),(0,r.jsxs)("div",{className:"card-apple-content",children:[(0,r.jsxs)("div",{className:"mb-4 sm:mb-6 relative",style:{zIndex:1e4},children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{ref:S,type:"text",value:v,onChange:e=>E(e.target.value),onKeyDown:e=>{"Enter"===e.key?(e.preventDefault(),z(),f(!1)):"Escape"===e.key&&f(!1)},onFocus:()=>{j.length>0&&f(!0)},placeholder:"搜尋客戶姓名、電話或項目編號...",className:"w-full pl-10 sm:pl-12 pr-20 sm:pr-24 py-2 sm:py-3 bg-bg-secondary border-transparent focus:bg-white focus:border-mingcare-blue focus:shadow-apple-focus rounded-apple-sm text-sm transition-all duration-200"}),(0,r.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 sm:pl-4 flex items-center pointer-events-none",children:(0,r.jsx)("svg",{className:"h-4 w-4 sm:h-5 sm:w-5 text-text-tertiary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),(0,r.jsxs)("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 sm:pr-3 space-x-1 sm:space-x-2",children:[v&&(0,r.jsx)("button",{onClick:()=>{g("");let e={...p};delete e.search,h(e),k(1),I()},className:"text-text-tertiary hover:text-text-secondary transition-colors p-1",type:"button",children:(0,r.jsx)("svg",{className:"h-3 w-3 sm:h-4 sm:w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,r.jsxs)("button",{onClick:()=>z(),className:"btn-apple-primary py-1 px-2 sm:px-3 text-xs",type:"button",children:[(0,r.jsx)("span",{className:"hidden sm:inline",children:"搜尋"}),(0,r.jsx)("span",{className:"sm:hidden",children:(0,r.jsx)("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})})]})]})]}),(0,r.jsx)(c,{isVisible:b,suggestions:j,onSelectSuggestion:e=>{g(e.customer_name),f(!1),z(e.customer_name)},onClose:()=>f(!1),targetRef:S})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3 sm:grid-cols-4 sm:gap-4",children:[(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsxs)("label",{className:"block text-xs font-medium text-text-primary mb-1 flex items-center",children:[(0,r.jsx)("svg",{className:"w-3 h-3 mr-1 text-blue-600 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),(0,r.jsx)("span",{className:"truncate",children:"客戶類型"})]}),(0,r.jsxs)("select",{value:p.customer_type||"",onChange:e=>{let t={...p};e.target.value?t.customer_type=e.target.value:delete t.customer_type,h(t),k(1)},className:"w-full text-xs bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all",children:[(0,r.jsx)("option",{value:"",children:"全部"}),(0,r.jsx)("option",{value:"社區券客戶",children:"社區券"}),(0,r.jsx)("option",{value:"明家街客",children:"明家街客"})]})]}),(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsxs)("label",{className:"block text-xs font-medium text-text-primary mb-1 flex items-center",children:[(0,r.jsxs)("svg",{className:"w-3 h-3 mr-1 text-green-600 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]}),(0,r.jsx)("span",{className:"truncate",children:"地區"})]}),(0,r.jsxs)("select",{value:p.district||"",onChange:e=>{let t={...p};e.target.value?t.district=e.target.value:delete t.district,h(t),k(1)},className:"w-full text-xs bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all",children:[(0,r.jsx)("option",{value:"",children:"全部"}),(0,r.jsx)("option",{value:"中西區",children:"中西區"}),(0,r.jsx)("option",{value:"灣仔區",children:"灣仔區"}),(0,r.jsx)("option",{value:"東區",children:"東區"}),(0,r.jsx)("option",{value:"南區",children:"南區"}),(0,r.jsx)("option",{value:"深水埗區",children:"深水埗"}),(0,r.jsx)("option",{value:"油尖旺區",children:"油尖旺"}),(0,r.jsx)("option",{value:"九龍城區",children:"九龍城"}),(0,r.jsx)("option",{value:"黃大仙區",children:"黃大仙"}),(0,r.jsx)("option",{value:"觀塘區",children:"觀塘區"}),(0,r.jsx)("option",{value:"荃灣區",children:"荃灣區"}),(0,r.jsx)("option",{value:"屯門區",children:"屯門區"}),(0,r.jsx)("option",{value:"元朗區",children:"元朗區"}),(0,r.jsx)("option",{value:"北區",children:"北區"}),(0,r.jsx)("option",{value:"大埔區",children:"大埔區"}),(0,r.jsx)("option",{value:"沙田區",children:"沙田區"}),(0,r.jsx)("option",{value:"西貢區",children:"西貢區"}),(0,r.jsx)("option",{value:"葵青區",children:"葵青區"}),(0,r.jsx)("option",{value:"離島區",children:"離島區"})]})]}),(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsxs)("label",{className:"block text-xs font-medium text-text-primary mb-1 flex items-center",children:[(0,r.jsx)("svg",{className:"w-3 h-3 mr-1 text-purple-600 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),(0,r.jsx)("span",{className:"truncate",children:"介紹人"})]}),(0,r.jsxs)("select",{value:p.introducer||"",onChange:e=>{let t={...p};e.target.value?t.introducer=e.target.value:delete t.introducer,h(t),k(1)},className:"w-full text-xs bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all",children:[(0,r.jsx)("option",{value:"",children:"全部"}),(0,r.jsx)("option",{value:"Kanas Leung",children:"Kanas"}),(0,r.jsx)("option",{value:"Joe Cheung",children:"Joe"}),(0,r.jsx)("option",{value:"Candy Ho",children:"Candy"}),(0,r.jsx)("option",{value:"Steven Kwok",children:"Steven"}),(0,r.jsx)("option",{value:"Dr.Lee",children:"Dr.Lee"}),(0,r.jsx)("option",{value:"Annie",children:"Annie"}),(0,r.jsx)("option",{value:"Janet",children:"Janet"}),(0,r.jsx)("option",{value:"陸sir",children:"陸sir"}),(0,r.jsx)("option",{value:"吳翹政",children:"吳翹政"}),(0,r.jsx)("option",{value:"余翠英",children:"余翠英"}),(0,r.jsx)("option",{value:"陳小姐MC01",children:"陳小姐"}),(0,r.jsx)("option",{value:"曾先生",children:"曾先生"})]})]}),(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsxs)("label",{className:"block text-xs font-medium text-text-primary mb-1 flex items-center",children:[(0,r.jsx)("svg",{className:"w-3 h-3 mr-1 text-orange-600 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m8 6V8a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2z"})}),(0,r.jsx)("span",{className:"truncate",children:"負責同事"})]}),(0,r.jsxs)("select",{value:p.project_manager||"",onChange:e=>{let t={...p};e.target.value?t.project_manager=e.target.value:delete t.project_manager,h(t),k(1)},className:"w-full text-xs bg-gray-50 border border-gray-200 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all",children:[(0,r.jsx)("option",{value:"",children:"全部"}),(0,r.jsx)("option",{value:"Kanas Leung",children:"Kanas"}),(0,r.jsx)("option",{value:"Joe Cheung",children:"Joe"}),(0,r.jsx)("option",{value:"Candy Ho",children:"Candy"})]})]})]}),(Object.keys(p).length>0||v.trim())&&(0,r.jsx)("div",{className:"mt-3 flex justify-center",children:(0,r.jsxs)("button",{onClick:async()=>{h({}),k(1),g(""),f(!1);try{o(!0);let{data:e,count:t}=await i.n.getCustomers({},1,C);x(e),_(t)}catch(e){console.error("重新載入客戶列表失敗:",e)}finally{o(!1)}},className:"text-xs bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded-lg flex items-center space-x-1 transition-all border border-red-200 hover:border-red-300",children:[(0,r.jsx)("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),(0,r.jsx)("span",{children:"清除篩選"})]})})]})]}),(0,r.jsx)("div",{className:"card-apple mb-4 fade-in-apple",style:{animationDelay:"0.2s"},children:(0,r.jsx)("div",{className:"px-4 py-3",children:(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4",children:[(0,r.jsxs)("span",{className:"text-sm text-text-primary",children:["共 ",(0,r.jsx)("span",{className:"font-semibold text-mingcare-blue",children:N})," 位客戶"]}),Object.keys(p).length>0&&(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("span",{className:"text-xs text-text-secondary",children:"篩選:"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-1",children:[p.customer_type&&(0,r.jsx)("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs",children:p.customer_type}),p.district&&(0,r.jsx)("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs",children:p.district}),p.introducer&&(0,r.jsx)("span",{className:"px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs",children:p.introducer}),p.project_manager&&(0,r.jsx)("span",{className:"px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs",children:p.project_manager}),p.search&&(0,r.jsxs)("span",{className:"px-2 py-0.5 bg-gray-100 text-gray-700 rounded text-xs",children:["搜尋: ",p.search]})]})]})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2 sm:space-x-3",children:[(0,r.jsxs)("button",{onClick:()=>D.push("/clients/new"),className:"text-xs sm:text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg flex items-center space-x-1 transition-all",children:[(0,r.jsx)("svg",{className:"h-3 w-3 sm:h-4 sm:w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),(0,r.jsx)("span",{className:"hidden sm:inline",children:"新增客戶"}),(0,r.jsx)("span",{className:"sm:hidden",children:"新增"})]}),(0,r.jsxs)("div",{className:"flex rounded-lg border border-gray-200 p-0.5 bg-gray-50",children:[(0,r.jsx)("button",{onClick:()=>u("card"),className:"px-2 py-1 text-xs font-medium rounded transition-all duration-200 ".concat("card"===m?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"),children:(0,r.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,r.jsx)("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})}),(0,r.jsx)("span",{className:"hidden sm:inline",children:"卡片"})]})}),(0,r.jsx)("button",{onClick:()=>u("list"),className:"px-2 py-1 text-xs font-medium rounded transition-all duration-200 ".concat("list"===m?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"),children:(0,r.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,r.jsx)("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 10h16M4 14h16M4 18h16"})}),(0,r.jsx)("span",{className:"hidden sm:inline",children:"列表"})]})})]})]})]})})}),(0,r.jsx)("div",{className:"card-apple fade-in-apple",style:{animationDelay:"0.3s"},children:(0,r.jsx)("div",{className:"card-apple-content",children:0===d.length?(0,r.jsxs)("div",{className:"text-center py-16",children:[(0,r.jsx)("svg",{className:"mx-auto h-16 w-16 text-text-tertiary mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),(0,r.jsx)("h3",{className:"text-apple-heading text-text-primary mb-2",children:Object.keys(p).length>0?"沒有符合條件的客戶":"暫無客戶資料"}),(0,r.jsx)("p",{className:"text-apple-body text-text-secondary mb-6 max-w-md mx-auto",children:Object.keys(p).length>0?"嘗試調整搜尋條件或篩選器以找到您需要的客戶":"開始新增客戶以建立您的客戶資料庫"}),(0,r.jsxs)("button",{type:"button",onClick:()=>D.push("/clients/new"),className:"btn-apple-primary",children:[(0,r.jsx)("svg",{className:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"新增客戶"]})]}):(0,r.jsx)(r.Fragment,{children:"card"===m?(0,r.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-6",children:d.map((e,t)=>(0,r.jsxs)("div",{className:"group cursor-pointer transition-all duration-500 hover:shadow-2xl hover:scale-105 hover:-translate-y-2 relative overflow-hidden transform hover:rotate-1 card-hover-float pulse-glow rounded-2xl md:rounded-3xl border-2 border-gray-100 hover:border-transparent bg-white shadow-lg",style:{animationDelay:"".concat(.4+.05*t,"s")},onClick:()=>D.push("/clients/".concat(e.customer_id||e.id,"/edit")),children:[(0,r.jsx)("div",{className:"px-3 py-2 md:px-4 md:py-3 text-white font-medium text-xs md:text-sm rounded-t-2xl md:rounded-t-3xl ".concat("社區券客戶"===e.customer_type?"bg-gradient-to-r from-green-500 to-green-600":"bg-gradient-to-r from-blue-500 to-blue-600"),children:(0,r.jsx)("div",{className:"flex items-center justify-center",children:(0,r.jsx)("span",{children:e.customer_type})})}),(0,r.jsxs)("div",{className:"p-3 md:p-6 bg-white rounded-b-2xl md:rounded-b-3xl relative z-10",children:[(0,r.jsx)("div",{className:"flex justify-between items-start mb-2 md:mb-4",children:(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h3",{className:"text-base md:text-xl font-bold text-gray-900 truncate mb-1 group-hover:text-gray-700 transition-colors duration-300",children:e.customer_name}),(0,r.jsx)("p",{className:"text-xs md:text-sm text-gray-500 group-hover:text-gray-400 transition-colors duration-300",children:e.customer_id||"未分配編號"})]})}),(0,r.jsxs)("div",{className:"space-y-2 md:space-y-3 mb-2 md:mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center text-xs md:text-apple-caption text-text-secondary",children:[(0,r.jsx)("svg",{className:"h-3 w-3 md:h-4 md:w-4 mr-2 md:mr-3 text-text-tertiary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})}),e.phone]}),(0,r.jsxs)("div",{className:"flex items-start text-xs md:text-apple-caption text-text-secondary",children:[(0,r.jsxs)("svg",{className:"h-3 w-3 md:h-4 md:w-4 mr-2 md:mr-3 mt-0.5 text-text-tertiary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]}),(0,r.jsx)("span",{className:"line-clamp-2",children:e.service_address})]})]}),(0,r.jsxs)("div",{className:"space-y-1.5 md:space-y-2 mb-2 md:mb-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-1.5 md:gap-2",children:[e.voucher_application_status&&(0,r.jsxs)("div",{className:"text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary block mb-0.5 md:mb-1 text-xs",children:"社區券："}),(0,r.jsx)("span",{className:"px-1.5 py-0.5 md:px-2 md:py-1 rounded-full text-xs w-full text-center block ".concat("已經持有"===e.voucher_application_status?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"),children:e.voucher_application_status})]}),e.lds_status&&(0,r.jsxs)("div",{className:"text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary block mb-0.5 md:mb-1 text-xs",children:"LDS："}),(0,r.jsx)("span",{className:"px-1.5 py-0.5 md:px-2 md:py-1 rounded-full text-xs w-full text-center block ".concat("已完成評估"===e.lds_status||"已經持有"===e.lds_status?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"),children:e.lds_status})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-1.5 md:gap-2",children:[e.home_visit_status&&(0,r.jsxs)("div",{className:"text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary block mb-0.5 md:mb-1 text-xs",children:"家訪："}),(0,r.jsx)("span",{className:"px-1.5 py-0.5 md:px-2 md:py-1 rounded-full text-xs w-full text-center block ".concat("已完成"===e.home_visit_status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.home_visit_status})]}),e.copay_level&&(0,r.jsxs)("div",{className:"text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary block mb-0.5 md:mb-1 text-xs",children:"自付："}),(0,r.jsx)("span",{className:"px-1.5 py-0.5 md:px-2 md:py-1 rounded-full text-xs bg-purple-100 text-purple-800 w-full text-center block",children:e.copay_level})]})]})]}),(0,r.jsx)("div",{className:"pt-2 md:pt-4 border-t border-border-light text-right",children:(0,r.jsx)("span",{className:"text-xs text-text-tertiary",children:new Date(e.created_at).toLocaleDateString("zh-TW")})})]})]},e.id))}):(0,r.jsx)("div",{className:"overflow-hidden rounded-apple-sm border border-border-light",children:(0,r.jsxs)("table",{className:"min-w-full divide-y divide-border-light",children:[(0,r.jsx)("thead",{className:"bg-bg-tertiary",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-6 py-4 text-left text-xs font-semibold text-text-primary uppercase tracking-wider",children:"客戶資料"}),(0,r.jsx)("th",{className:"px-6 py-4 text-left text-xs font-semibold text-text-primary uppercase tracking-wider",children:"聯絡資訊"}),(0,r.jsx)("th",{className:"px-6 py-4 text-left text-xs font-semibold text-text-primary uppercase tracking-wider",children:"服務地址"}),(0,r.jsx)("th",{className:"px-6 py-4 text-left text-xs font-semibold text-text-primary uppercase tracking-wider",children:"類型"}),(0,r.jsx)("th",{className:"px-6 py-4 text-left text-xs font-semibold text-text-primary uppercase tracking-wider",children:"狀態資訊"}),(0,r.jsx)("th",{className:"px-6 py-4 text-left text-xs font-semibold text-text-primary uppercase tracking-wider",children:"建立日期"})]})}),(0,r.jsx)("tbody",{className:"bg-white divide-y divide-border-light",children:d.map((e,t)=>(0,r.jsxs)("tr",{className:"hover:bg-bg-tertiary transition-colors cursor-pointer",onClick:()=>D.push("/clients/".concat(e.customer_id||e.id,"/edit")),children:[(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-1 h-8 rounded-full mr-3 ".concat("社區券客戶"===e.customer_type?"bg-green-500":"bg-blue-500")}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-apple-body text-text-primary font-medium",children:e.customer_name}),(0,r.jsx)("div",{className:"text-apple-caption text-text-secondary",children:e.customer_id||"未分配編號"})]})]})}),(0,r.jsx)("td",{className:"px-6 py-4",children:(0,r.jsx)("div",{className:"text-apple-caption text-text-primary",children:e.phone})}),(0,r.jsx)("td",{className:"px-6 py-4",children:(0,r.jsx)("div",{className:"text-apple-caption text-text-primary max-w-xs",children:(0,r.jsx)("div",{className:"line-clamp-2",children:e.service_address})})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,r.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat("社區券客戶"===e.customer_type?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800"),children:e.customer_type})}),(0,r.jsx)("td",{className:"px-6 py-4",children:(0,r.jsxs)("div",{className:"space-y-1",children:[e.voucher_application_status&&(0,r.jsxs)("div",{className:"flex items-center text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary mr-1",children:"社區券："}),(0,r.jsx)("span",{className:"px-2 py-1 rounded-full text-xs ".concat("已經持有"===e.voucher_application_status?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"),children:e.voucher_application_status})]}),e.lds_status&&(0,r.jsxs)("div",{className:"flex items-center text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary mr-1",children:"LDS："}),(0,r.jsx)("span",{className:"px-2 py-1 rounded-full text-xs ".concat("已完成評估"===e.lds_status||"已經持有"===e.lds_status?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"),children:e.lds_status})]}),e.home_visit_status&&(0,r.jsxs)("div",{className:"flex items-center text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary mr-1",children:"家訪："}),(0,r.jsx)("span",{className:"px-2 py-1 rounded-full text-xs ".concat("已完成"===e.home_visit_status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.home_visit_status})]}),e.copay_level&&(0,r.jsxs)("div",{className:"flex items-center text-xs",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary mr-1",children:"自付："}),(0,r.jsx)("span",{className:"px-2 py-1 rounded-full text-xs bg-purple-100 text-purple-800",children:e.copay_level})]})]})}),(0,r.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-apple-caption text-text-secondary",children:new Date(e.created_at).toLocaleDateString("zh-TW")})]},e.id))})]})})})})}),d.length>0&&(0,r.jsx)("div",{className:"card-apple fade-in-apple",style:{animationDelay:"0.4s"},children:(0,r.jsxs)("div",{className:"card-apple-content flex flex-col sm:flex-row justify-between items-center py-6",children:[(0,r.jsxs)("div",{className:"text-apple-caption text-text-secondary mb-4 sm:mb-0",children:["顯示第 ",(0,r.jsx)("span",{className:"font-medium",children:O})," 到 ",(0,r.jsx)("span",{className:"font-medium",children:q})," 項， 共 ",(0,r.jsx)("span",{className:"font-medium",children:N})," 項結果"]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("button",{onClick:()=>B(w-1),disabled:w<=1,className:"btn-apple-secondary px-3 py-2 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,r.jsx)("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsx)("div",{className:"flex items-center space-x-1",children:Array.from({length:Math.min(5,W)},(e,t)=>{let s;return s=W<=5?t+1:w<=3?t+1:w>=W-2?W-4+t:w-2+t,(0,r.jsx)("button",{onClick:()=>B(s),className:s===w?"btn-apple-primary px-3 py-2 text-sm":"btn-apple-secondary px-3 py-2 text-sm",children:s},s)})}),(0,r.jsx)("button",{onClick:()=>B(w+1),disabled:w>=W,className:"btn-apple-secondary px-3 py-2 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,r.jsx)("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]})]})})]})]})}},2141:function(e,t,s){"use strict";s.d(t,{O:function(){return r}});let r=(0,s(3960).AY)("https://cvkxlvdicympakfecgvv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3hsdmRpY3ltcGFrZmVjZ3Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MjkxODEsImV4cCI6MjA2NzAwNTE4MX0.jp2fPKcBcG4-042UoN3OieR553WAgABhJIujiDJAt-I")},8478:function(e,t,s){"use strict";s.d(t,{n:function(){return a}});var r=s(2141);class a{static isUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)}static async queryBySmartId(e,t){let s=this.isUUID(e),a=s?"id":"customer_id";return console.log("Using ".concat(a," query for ").concat(s?"UUID":"customer number",":"),e),t(r.O.from("customer_personal_data"),a)}static async generateNextCustomerId(e,t){try{let{data:s,error:a}=await r.O.rpc("generate_next_customer_id",{p_customer_type:e,p_introducer:t||null});if(a)throw console.error("RPC 錯誤:",a),Error("生成客戶編號失敗: ".concat(a.message));if(!s)throw Error("RPC 未返回編號");return s}catch(e){throw console.error("生成客戶編號失敗:",e),Error("生成客戶編號失敗: ".concat(e.message||"未知錯誤"))}}static async getSearchSuggestions(e){try{if(e.query.length<2)return{data:[],error:"請輸入至少 2 個字元後再搜尋"};let t=e.query.trim(),s=e.limit||10,{data:a,error:n}=await r.O.from("customer_personal_data").select("id, customer_id, customer_name, phone").or("customer_name.ilike.%".concat(t,"%,phone.ilike.%").concat(t,"%,customer_id.ilike.%").concat(t,"%")).order("created_at",{ascending:!1}).limit(s);if(n)throw n;return{data:(a||[]).map(e=>({id:e.id,customer_id:e.customer_id,customer_name:e.customer_name,phone:e.phone,display_text:"".concat(e.customer_name," - ").concat(e.phone).concat(e.customer_id?" - ".concat(e.customer_id):" - 未分配編號")}))}}catch(e){return{data:[],error:"搜尋建議載入失敗",message:e.message}}}static async getCustomers(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;try{let a=r.O.from("customer_personal_data").select("\n          id,\n          customer_id,\n          customer_name,\n          phone,\n          district,\n          service_address,\n          project_manager,\n          created_at,\n          customer_type,\n          voucher_application_status,\n          lds_status,\n          home_visit_status,\n          copay_level\n        ",{count:"exact"});(null==e?void 0:e.customer_type)&&(a=a.eq("customer_type",e.customer_type)),(null==e?void 0:e.district)&&(a=a.eq("district",e.district)),(null==e?void 0:e.introducer)&&(a=a.eq("introducer",e.introducer)),(null==e?void 0:e.project_manager)&&(a=a.eq("project_manager",e.project_manager)),(null==e?void 0:e.search)&&(a=a.or("customer_name.ilike.%".concat(e.search,"%,phone.ilike.%").concat(e.search,"%,customer_id.ilike.%").concat(e.search,"%")));let n=(t-1)*s;a=(a=a.range(n,n+s-1)).order("created_at",{ascending:!1});let{data:l,error:i,count:o}=await a;if(i)throw i;return{data:l||[],count:o||0,page:t,pageSize:s,totalPages:Math.ceil((o||0)/s)}}catch(e){return console.error("獲取客戶列表失敗:",e),{data:[],count:0,page:t,pageSize:s,totalPages:0}}}static async getCustomerById(e){try{console.log("Fetching customer with ID:",e);let{data:t,error:s}=await this.queryBySmartId(e,(t,s)=>t.select("*").eq(s,e).single());if(s&&"PGRST116"===s.code){console.log("First query failed, trying alternative method...");let t=this.isUUID(e),s=await r.O.from("customer_personal_data").select("*").eq(t?"customer_id":"id",e).single();if(s.error)throw console.error("Database error:",s.error),s.error;return console.log("Customer data found via alternative method:",s.data),{data:s.data||void 0}}if(s)throw console.error("Database error:",s),s;return console.log("Customer data found:",t),{data:t||void 0}}catch(e){return console.error("Service error:",e),{error:"客戶資料載入失敗",message:e.message}}}static async createCustomer(e){try{let t=await this.generateNextCustomerId(e.customer_type,e.introducer),s={customer_id:t,customer_type:e.customer_type,customer_name:e.customer_name,service_address:e.service_address,charity_support:e.charity_support||!1,phone:e.phone||null,hkid:e.hkid||null,dob:e.dob||null,age:e.age||null,district:e.district||null,health_status:e.health_status||null,introducer:e.introducer||null,voucher_application_status:e.voucher_application_status||null,lds_status:e.lds_status||null,home_visit_status:e.home_visit_status||null,project_manager:e.staff_owner||null,copay_level:e.copay_level||null,voucher_number:e.voucher_number||null,created_at:new Date().toISOString()},{error:a}=await r.O.from("customer_personal_data").insert([s]);if(a)throw console.error("Supabase 插入錯誤:",a),Error(a.message);return{success:!0,customer_id:t}}catch(e){return console.error("新增客戶失敗:",e),{success:!1,error:e.message||"新增客戶失敗"}}}static async updateCustomer(e,t){try{if(t.dob){let e=new Date(t.dob),s=new Date;t.age=s.getFullYear()-e.getFullYear();let r=s.getMonth()-e.getMonth();(r<0||0===r&&s.getDate()<e.getDate())&&t.age--}let s=await this.queryBySmartId(e,(s,r)=>s.update(t).eq(r,e).select().single());if(s.error)throw s.error;return{data:s.data||void 0}}catch(e){return{error:"客戶資料更新失敗",message:e.message}}}static async deleteCustomer(e){try{let t=await this.queryBySmartId(e,(t,s)=>t.delete().eq(s,e));if(t.error)throw t.error;return{}}catch(e){return{error:"客戶刪除失敗",message:e.message}}}static validateCustomerData(e){var t,s,r,a,n,l,i,o,c,d,x;let m={};return(null===(t=e.customer_name)||void 0===t?void 0:t.trim())||(m.customer_name="客戶姓名為必填欄位"),(null===(s=e.phone)||void 0===s?void 0:s.trim())||(m.phone="電話為必填欄位"),(null===(r=e.district)||void 0===r?void 0:r.trim())||(m.district="地區為必填欄位"),(null===(a=e.service_address)||void 0===a?void 0:a.trim())||(m.service_address="服務地址為必填欄位"),(null===(n=e.hkid)||void 0===n?void 0:n.trim())||(m.hkid="身份證號碼為必填欄位"),(null===(l=e.dob)||void 0===l?void 0:l.trim())||(m.dob="出生日期為必填欄位"),(null===(i=e.health_status)||void 0===i?void 0:i.trim())||(m.health_status="身體狀況為必填欄位"),(null===(o=e.introducer)||void 0===o?void 0:o.trim())||(m.introducer="介紹人為必填欄位"),(null===(c=e.project_manager)||void 0===c?void 0:c.trim())||(m.project_manager="項目經理為必填欄位"),e.phone&&!/^[0-9]{8}$/.test(e.phone)&&(m.phone="電話格式錯誤，請輸入 8 位數字"),e.hkid&&!/^[A-Z]{1,2}[0-9]{6}([0-9A])$/.test(e.hkid)&&(m.hkid="HKID 格式錯誤"),e.dob&&new Date(e.dob)>new Date&&(m.dob="出生日期不能是未來日期"),"已經持有"!==e.voucher_application_status||((null===(d=e.voucher_number)||void 0===d?void 0:d.trim())||(m.voucher_number="voucher_number：只有 voucher_application_status=已經持有 時必填"),(null===(x=e.copay_level)||void 0===x?void 0:x.trim())||(m.copay_level="請選擇自付比例（copay_level）")),"5%"===e.copay_level&&void 0===e.charity_support&&(m.charity_support="copay_level 為 5% 時，必須選擇慈善資助（charity_support）"),{isValid:0===Object.keys(m).length,errors:m}}}}},function(e){e.O(0,[998,971,117,744],function(){return e(e.s=3330)}),_N_E=e.O()}]);