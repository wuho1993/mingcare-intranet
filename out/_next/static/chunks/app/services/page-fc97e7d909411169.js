(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[469],{6615:function(e,t,a){Promise.resolve().then(a.bind(a,9496))},9496:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return w}});var r=a(7437),s=a(2265),n=a(4887),l=a(9376),c=a(2141);let o=[{value:"ES-護送服務(陪診)",label:"ES-護送服務(陪診)"},{value:"HC-家居服務",label:"HC-家居服務"},{value:"NC-護理服務(專業⼈員)",label:"NC-護理服務(專業⼈員)"},{value:"PC-到⼾看顧(輔助⼈員)",label:"PC-到⼾看顧(輔助⼈員)"},{value:"RA-復康運動(輔助⼈員)",label:"RA-復康運動(輔助⼈員)"},{value:"RT-復康運動(OTA輔助⼈員)",label:"RT-復康運動(OTA輔助⼈員)"},{value:"RT-復康運動(專業⼈員)",label:"RT-復康運動(專業⼈員)"},{value:"上門評估服務",label:"上門評估服務"},{value:"傷口護理",label:"傷口護理"},{value:"免費服務體驗",label:"免費服務體驗"}],i=[{value:"MC社區券(醫點）",label:"MC社區券(醫點）"},{value:"MC街客",label:"MC街客"},{value:"Steven140",label:"Steven140"},{value:"Steven200",label:"Steven200"},{value:"Steven醫點",label:"Steven醫點"}],d=[{value:"Candy Ho",label:"Candy Ho"},{value:"Joe Cheung",label:"Joe Cheung"},{value:"Kanas Leung",label:"Kanas Leung"}];async function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;try{let r=c.O.from("billing_salary_data").select("*",{count:"exact"});e.dateRange.start&&e.dateRange.end&&(r=r.gte("service_date",e.dateRange.start).lte("service_date",e.dateRange.end)),e.serviceType&&(r=r.eq("service_type",e.serviceType)),e.projectCategory&&(r=r.eq("project_category",e.projectCategory)),e.projectManager&&(r=r.eq("project_manager",e.projectManager)),e.careStaffName&&(r=r.ilike("care_staff_name","%".concat(e.careStaffName,"%"))),e.selectedCustomerIds&&e.selectedCustomerIds.length>0?r=r.in("customer_id",e.selectedCustomerIds):e.searchTerm&&e.searchTerm.length>=2&&(r=r.or("customer_name.ilike.%".concat(e.searchTerm,"%,phone.ilike.%").concat(e.searchTerm,"%,customer_id.ilike.%").concat(e.searchTerm,"%")));let s=(t-1)*a,{data:n,error:l,count:o}=await r.order("service_date",{ascending:!1}).order("start_time",{ascending:!0}).range(s,s+a-1);if(l)return console.error("Error fetching billing salary records:",l),{success:!1,error:l.message};let i=(n||[]).map(e=>({...e,profit:(e.service_fee||0)-(e.staff_salary||0)}));return{success:!0,data:{data:i,total:o||0,page:t,pageSize:a,totalPages:Math.ceil((o||0)/a)}}}catch(e){return console.error("Error in fetchBillingSalaryRecords:",e),{success:!1,error:e instanceof Error?e.message:"獲取記錄時發生錯誤"}}}async function x(e,t){try{let{data:a,error:r}=await c.O.from("billing_salary_data").update(t).eq("id",e).select().single();if(r)return console.error("Error updating billing salary record:",r),{success:!1,error:r.message};return{success:!0,data:a,message:"記錄更新成功"}}catch(e){return console.error("Error in updateBillingSalaryRecord:",e),{success:!1,error:e instanceof Error?e.message:"更新記錄時發生錯誤"}}}async function u(e){try{let{error:t}=await c.O.from("billing_salary_data").delete().eq("id",e);if(t)return console.error("Error deleting billing salary record:",t),{success:!1,error:t.message};return{success:!0,message:"記錄刪除成功"}}catch(e){return console.error("Error in deleteBillingSalaryRecord:",e),{success:!1,error:e instanceof Error?e.message:"刪除記錄時發生錯誤"}}}async function p(e){try{let{data:t,error:a}=await c.O.from("billing_salary_data").select("service_fee, staff_salary, service_hours").gte("service_date",e.start).lte("service_date",e.end);if(a)return console.error("Error getting current KPI:",a),{success:!1,error:a.message};let r=new Date(e.start),s=new Date(e.end),n=new Date(r);n.setMonth(n.getMonth()-1);let l=new Date(s);l.setMonth(l.getMonth()-1);let{data:o,error:i}=await c.O.from("billing_salary_data").select("service_fee, staff_salary, service_hours").gte("service_date",n.toISOString().split("T")[0]).lte("service_date",l.toISOString().split("T")[0]);i&&console.warn("Error getting last month KPI for comparison:",i);let d=(null==t?void 0:t.reduce((e,t)=>e+(t.service_fee||0),0))||0,m=(null==t?void 0:t.reduce((e,t)=>e+(t.staff_salary||0),0))||0,x=d-m,u=(null==t?void 0:t.reduce((e,t)=>e+(t.service_hours||0),0))||0,p=(null==o?void 0:o.reduce((e,t)=>e+(t.service_fee||0),0))||0,h=p>0?(d-p)/p*100:d>0?100:0;return console.log("KPI Debug:",{currentPeriod:"".concat(e.start," to ").concat(e.end),lastMonthPeriod:"".concat(n.toISOString().split("T")[0]," to ").concat(l.toISOString().split("T")[0]),currentRecords:(null==t?void 0:t.length)||0,lastMonthRecords:(null==o?void 0:o.length)||0,totalRevenue:d,lastMonthRevenue:p,revenueGrowthRate:h}),{success:!0,data:{totalRevenue:d,totalProfit:x,totalServiceHours:u,avgProfitPerHour:u>0?x/u:0,revenueGrowthRate:h}}}catch(e){return console.error("Error in getBusinessKPI:",e),{success:!1,error:e instanceof Error?e.message:"獲取 KPI 時發生錯誤"}}}async function h(e){try{let{data:t,error:a}=await c.O.from("billing_salary_data").select("project_category, service_fee, staff_salary, service_hours, customer_name").gte("service_date",e.start).lte("service_date",e.end);if(a)return console.error("Error getting project category summary:",a),{success:!1,error:a.message};let r=new Map,s=new Map;t.forEach(e=>{let t=e.project_category;if(!t)return;let a=r.get(t)||{category:t,totalFee:0,totalHours:0,totalProfit:0,recordCount:0,uniqueCustomers:0};if(a.totalFee+=e.service_fee||0,a.totalHours+=e.service_hours||0,a.totalProfit+=(e.service_fee||0)-(e.staff_salary||0),a.recordCount+=1,r.set(t,a),s.has(t)||s.set(t,new Set),e.customer_name){var n;null===(n=s.get(t))||void 0===n||n.add(e.customer_name)}}),r.forEach((e,t)=>{var a;e.uniqueCustomers=(null===(a=s.get(t))||void 0===a?void 0:a.size)||0});let n=Array.from(r.values()).sort((e,t)=>t.totalFee-e.totalFee);return{success:!0,data:n}}catch(e){return console.error("Error in getProjectCategorySummary:",e),{success:!1,error:e instanceof Error?e.message:"獲取項目分類統計時發生錯誤"}}}async function g(e){try{if(!e.trim()||e.length<1)return{success:!0,data:[]};let[t,a]=await Promise.all([c.O.from("billing_salary_data").select("customer_name, customer_id, phone, service_address").or("customer_name.ilike.%".concat(e,"%,customer_id.ilike.%").concat(e,"%,phone.ilike.%").concat(e,"%")).not("customer_name","is",null).not("customer_id","is",null).limit(20),c.O.from("customer_personal_data").select("customer_name, customer_id, phone, service_address").or("customer_name.ilike.%".concat(e,"%,customer_id.ilike.%").concat(e,"%,phone.ilike.%").concat(e,"%")).not("customer_name","is",null).not("customer_id","is",null).limit(20)]);t.error&&console.error("計費記錄搜尋錯誤:",t.error),a.error&&console.error("客戶資料搜尋錯誤:",a.error);let r=[...t.data||[],...a.data||[]],s=new Map;r.forEach(e=>{if(e.customer_name&&e.customer_id){let t=e.customer_id;if(s.has(t)){let a=s.get(t);!a.service_address&&e.service_address&&(a.service_address=e.service_address)}else s.set(t,{customer_name:e.customer_name,customer_id:e.customer_id,phone:e.phone||"",service_address:e.service_address||"",display_text:"".concat(e.customer_name," (").concat(e.customer_id,")").concat(e.phone?" - "+e.phone:"")})}});let n=Array.from(s.values()).sort((e,t)=>e.customer_name.localeCompare(t.customer_name)).slice(0,8);return{success:!0,data:n}}catch(e){return console.error("客戶搜尋失敗:",e),{success:!1,error:e instanceof Error?e.message:"客戶搜尋失敗"}}}async function b(){try{let{data:e,error:t}=await c.O.from("care_staff_profiles").select("name_chinese").not("name_chinese","is",null).order("name_chinese");if(t)throw t;let a=Array.from(new Set((e||[]).map(e=>e.name_chinese).filter(e=>e&&e.trim().length>0))).map(e=>({name_chinese:e}));return{success:!0,data:a}}catch(e){return console.error("獲取護理人員列表失敗:",e),{success:!1,error:e instanceof Error?e.message:"獲取護理人員列表失敗"}}}let f=e=>{let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(a,"-").concat(r)};function v(e){let{filters:t,onEdit:a}=e,[n,l]=(0,s.useState)({}),[c,o]=(0,s.useState)(!0),[i,d]=(0,s.useState)(new Date);(0,s.useEffect)(()=>{(async()=>{o(!0);try{let e=await m(t,1,1e3);if(e.success&&e.data){let t={};e.data.data.forEach(e=>{let a=e.service_date;t[a]||(t[a]=[]),t[a].push(e)}),l(t)}}catch(e){console.error("載入月曆數據失敗:",e)}finally{o(!1)}})()},[t]);let x=e=>{let t=new Date(i);t.setMonth(i.getMonth()+("next"===e?1:-1)),d(t)},u=(()=>{let e=new Date(i.getFullYear(),i.getMonth(),1),t=new Date(e);t.setDate(t.getDate()-e.getDay());let a=[],r=new Date(t);for(let e=0;e<42;e++)a.push(new Date(r)),r.setDate(r.getDate()+1);return a})(),p=i.getMonth();return c?(0,r.jsxs)("div",{className:"flex items-center justify-center py-12",children:[(0,r.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-2 border-mingcare-blue border-t-transparent"}),(0,r.jsx)("span",{className:"ml-3 text-text-secondary",children:"載入月曆數據中..."})]}):(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("button",{onClick:()=>x("prev"),className:"p-2 rounded-lg border border-border-light hover:bg-bg-secondary transition-all duration-200",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsxs)("h4",{className:"text-lg font-medium text-text-primary",children:[i.getFullYear(),"年 ",i.getMonth()+1,"月"]}),(0,r.jsx)("button",{onClick:()=>x("next"),className:"p-2 rounded-lg border border-border-light hover:bg-bg-secondary transition-all duration-200",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),(0,r.jsx)("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["日","一","二","三","四","五","六"].map(e=>(0,r.jsx)("div",{className:"p-2 text-center font-medium text-text-secondary bg-bg-secondary rounded",children:e},e))}),(0,r.jsx)("div",{className:"grid grid-cols-7 gap-1",children:u.map((e,t)=>{let s=f(e),l=e.getMonth()===p,c=s===f(new Date),o=0===e.getDay()||6===e.getDay(),i=n[s]||[],d=i.length>0?Math.max(120,120+(i.length-1)*80):120;return(0,r.jsxs)("div",{style:{minHeight:"".concat(d,"px")},className:"\n                p-2 border rounded-lg\n                ".concat(l?o?"bg-blue-50 border-blue-200":"bg-bg-primary border-border-light":"bg-gray-50 text-gray-300 border-gray-200","\n                ").concat(c?"ring-2 ring-mingcare-blue border-mingcare-blue":"","\n              "),children:[(0,r.jsx)("div",{className:"\n                text-sm font-bold mb-2\n                ".concat(c?"text-mingcare-blue":l?"text-text-primary":"text-gray-300","\n              "),children:e.getDate()}),l&&i.length>0&&(0,r.jsxs)("div",{className:"space-y-1",children:[i.slice(0,3).map((e,t)=>(0,r.jsxs)("div",{onClick:()=>a(e),className:"text-sm bg-white border border-gray-200 rounded p-2 shadow-sm cursor-pointer hover:shadow-md hover:border-mingcare-blue transition-all duration-200",children:[(0,r.jsxs)("div",{className:"font-medium text-gray-800 mb-1 leading-tight",children:[e.customer_name,"/",e.care_staff_name]}),(0,r.jsx)("div",{className:"text-blue-600 mb-1 leading-tight",children:e.service_type}),(0,r.jsxs)("div",{className:"text-gray-600 text-sm",children:[e.start_time,"-",e.end_time]})]},"".concat(e.id,"-").concat(t))),i.length>3&&(0,r.jsxs)("div",{className:"text-sm text-text-secondary text-center py-1",children:["還有 ",i.length-3," 筆記錄..."]})]})]},t)})})]})}function y(e){let{filters:t}=e,[a,n]=(0,s.useState)([]),[l,c]=(0,s.useState)([]),[o,i]=(0,s.useState)(!0),[d,p]=(0,s.useState)(null),[h,g]=(0,s.useState)({field:"service_date",direction:"desc"}),[b,f]=(0,s.useState)(1),[v,y]=(0,s.useState)(0),[j,_]=(0,s.useState)(null),[N,w]=(0,s.useState)(!1);(0,s.useEffect)(()=>{S()},[t]);let S=async()=>{try{i(!0),p(null);let e=await m(t,1,1e4);if(e.success&&e.data){let t=e.data.data;y(e.data.total),c(t),C(t,h)}else p(e.error||"載入數據失敗")}catch(e){console.error("載入記錄失敗:",e),p("載入數據失敗，請重試")}finally{i(!1)}},C=(e,t)=>{n([...e].sort((e,a)=>{let r,s;switch(t.field){case"service_date":r=e.service_date,s=a.service_date;break;case"customer_name":r=e.customer_name,s=a.customer_name;break;case"customer_id":r=e.customer_id,s=a.customer_id;break;default:return 0}return r<s?"asc"===t.direction?-1:1:r>s?"asc"===t.direction?1:-1:0}))},D=e=>{let t=h.field===e&&"desc"===h.direction?"asc":"desc",a={field:e,direction:t};g(a),C(l,a)},M=e=>{_(e),w(!0)},F=async e=>{if(j)try{i(!0);let t=await x(j.id,e);t.success?(alert("記錄更新成功！"),await S(),w(!1),_(null)):(p(t.error||"更新記錄失敗"),alert("更新記錄失敗："+(t.error||"未知錯誤")))}catch(e){console.error("更新記錄失敗:",e),p("更新記錄失敗，請重試"),alert("更新記錄失敗，請重試")}finally{i(!1)}},L=async e=>{if(confirm("確定要刪除這筆記錄嗎？此操作無法撤銷。"))try{i(!0);let t=await u(e);t.success?await S():p(t.error||"刪除記錄失敗")}catch(e){console.error("刪除記錄失敗:",e),p("刪除記錄失敗，請重試")}finally{i(!1)}},R=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30;return e.length>t?e.substring(0,t)+"...":e};return o?(0,r.jsx)("div",{className:"space-y-4",children:[1,2,3].map(e=>(0,r.jsx)("div",{className:"border border-border-light rounded-lg p-4 animate-pulse",children:(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/6"})]}),(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-2/3"}),(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/2"})]})},e))}):d?(0,r.jsxs)("div",{className:"text-center py-12",children:[(0,r.jsx)("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),(0,r.jsx)("p",{className:"text-red-600 font-medium mb-2",children:d}),(0,r.jsx)("button",{onClick:S,className:"px-4 py-2 bg-mingcare-blue text-white rounded-lg hover:bg-opacity-90 transition-colors",children:"重新載入"})]}):0===a.length?(0,r.jsxs)("div",{className:"text-center py-12",children:[(0,r.jsx)("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)("svg",{className:"w-8 h-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),(0,r.jsx)("p",{className:"text-text-primary font-medium mb-2",children:"沒有找到記錄"}),(0,r.jsx)("p",{className:"text-sm text-text-secondary",children:"請調整篩選條件或新增服務記錄"})]}):(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between border-b border-border-light pb-4",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("span",{className:"text-sm text-text-secondary font-medium",children:"排序："}),(0,r.jsxs)("button",{onClick:()=>D("service_date"),className:"flex items-center space-x-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ".concat("service_date"===h.field?"bg-mingcare-blue text-white":"bg-bg-secondary text-text-secondary hover:bg-bg-tertiary"),children:[(0,r.jsx)("span",{children:"日期"}),"service_date"===h.field&&(0,r.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat("desc"===h.direction?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})]}),(0,r.jsxs)("button",{onClick:()=>D("customer_name"),className:"flex items-center space-x-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ".concat("customer_name"===h.field?"bg-mingcare-blue text-white":"bg-bg-secondary text-text-secondary hover:bg-bg-tertiary"),children:[(0,r.jsx)("span",{children:"客戶名稱"}),"customer_name"===h.field&&(0,r.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat("desc"===h.direction?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})]}),(0,r.jsxs)("button",{onClick:()=>D("customer_id"),className:"flex items-center space-x-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ".concat("customer_id"===h.field?"bg-mingcare-blue text-white":"bg-bg-secondary text-text-secondary hover:bg-bg-tertiary"),children:[(0,r.jsx)("span",{children:"客戶編號"}),"customer_id"===h.field&&(0,r.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat("desc"===h.direction?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})]})]}),(0,r.jsxs)("div",{className:"text-sm text-text-secondary",children:["共 ",a.length," 筆記錄"]})]}),(0,r.jsx)("div",{className:"space-y-3",children:a.map(e=>(0,r.jsxs)("div",{className:"border border-border-light rounded-lg p-4 hover:shadow-md transition-all duration-200 bg-white",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)("span",{className:"font-medium text-text-primary",children:e.service_date}),(0,r.jsx)("span",{className:"text-sm text-text-secondary",children:e.project_category})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("button",{onClick:()=>M(e),className:"p-2 text-mingcare-blue hover:bg-blue-50 rounded-lg transition-colors",title:"編輯記錄",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),(0,r.jsx)("button",{onClick:()=>L(e.id),className:"p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors",title:"刪除記錄",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("div",{className:"flex items-center space-x-2",children:(0,r.jsxs)("span",{className:"font-medium text-text-primary",children:[e.customer_name," (",e.customer_id,")"]})}),(0,r.jsx)("span",{className:"text-sm bg-mingcare-blue text-white px-3 py-1 rounded-full",children:e.service_type})]}),(0,r.jsx)("div",{className:"mb-2",children:(0,r.jsx)("span",{className:"text-sm text-text-secondary cursor-help block",title:e.service_address,children:R(e.service_address)})}),(0,r.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsxs)("span",{className:"text-text-secondary",children:[e.start_time,"-",e.end_time]}),(0,r.jsxs)("span",{className:"font-medium text-text-primary",children:[e.service_hours,"小時"]})]}),(0,r.jsx)("span",{className:"font-medium text-text-primary",children:e.care_staff_name})]})]},e.id))}),(0,r.jsxs)("div",{className:"text-center text-sm text-text-secondary mt-6",children:["共 ",v," 筆記錄"]}),N&&j&&(0,r.jsx)(k,{isOpen:N,onClose:()=>{w(!1),_(null)},onSubmit:F,isMultiDay:!1,existingRecord:j})]})}function j(e){let{filters:t,setFilters:a,updateDateRange:s,kpiData:n,kpiLoading:l,categorySummary:c}=e;return(0,r.jsxs)("div",{className:"space-y-8",children:[(0,r.jsx)("div",{className:"card-apple border border-border-light fade-in-apple",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-apple-heading text-text-primary mb-4",children:"選擇時段"}),(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>s("thisMonth"),className:"px-4 py-2 text-sm rounded-lg border border-border-light bg-mingcare-blue text-white transition-all duration-200",children:"本月"}),(0,r.jsx)("button",{onClick:()=>s("lastMonth"),className:"px-4 py-2 text-sm rounded-lg border border-border-light hover:bg-bg-secondary transition-all duration-200",children:"上月"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("select",{value:new Date(t.dateRange.start).getFullYear(),onChange:e=>{let r=parseInt(e.target.value),s=new Date(t.dateRange.start).getMonth(),n=new Date(r,s+1,0),l=r+"-"+String(s+1).padStart(2,"0")+"-01",c=n.getFullYear()+"-"+String(n.getMonth()+1).padStart(2,"0")+"-"+String(n.getDate()).padStart(2,"0");a(e=>({...e,dateRange:{start:l,end:c}}))},className:"px-3 py-2 text-sm border border-border-light rounded-lg bg-bg-primary text-text-primary focus:outline-none focus:ring-2 focus:ring-mingcare-blue focus:border-transparent",children:Array.from({length:5},(e,t)=>{let a=new Date().getFullYear()-2+t;return(0,r.jsxs)("option",{value:a,children:[a,"年"]},a)})}),(0,r.jsx)("select",{value:new Date(t.dateRange.start).getMonth(),onChange:e=>{let r=new Date(t.dateRange.start).getFullYear(),s=parseInt(e.target.value),n=new Date(r,s+1,0),l=r+"-"+String(s+1).padStart(2,"0")+"-01",c=n.getFullYear()+"-"+String(n.getMonth()+1).padStart(2,"0")+"-"+String(n.getDate()).padStart(2,"0");a(e=>({...e,dateRange:{start:l,end:c}}))},className:"px-3 py-2 text-sm border border-border-light rounded-lg bg-bg-primary text-text-primary focus:outline-none focus:ring-2 focus:ring-mingcare-blue focus:border-transparent",children:Array.from({length:12},(e,t)=>(0,r.jsxs)("option",{value:t,children:[t+1,"月"]},t))})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("label",{className:"text-sm text-text-secondary",children:"時間段："}),(0,r.jsx)("input",{type:"date",value:t.dateRange.start,onChange:e=>a(t=>({...t,dateRange:{...t.dateRange,start:e.target.value}})),className:"px-3 py-2 text-sm border border-border-light rounded-lg bg-bg-primary text-text-primary focus:outline-none focus:ring-2 focus:ring-mingcare-blue focus:border-transparent"}),(0,r.jsx)("span",{className:"text-text-secondary",children:"至"}),(0,r.jsx)("input",{type:"date",value:t.dateRange.end,onChange:e=>a(t=>({...t,dateRange:{...t.dateRange,end:e.target.value}})),className:"px-3 py-2 text-sm border border-border-light rounded-lg bg-bg-primary text-text-primary focus:outline-none focus:ring-2 focus:ring-mingcare-blue focus:border-transparent"})]}),(0,r.jsxs)("div",{className:"mt-4 text-sm text-text-secondary",children:["當前範圍：",t.dateRange.start," ~ ",t.dateRange.end]})]})}),(0,r.jsx)("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-6",children:l?(0,r.jsxs)("div",{className:"col-span-full text-center py-12",children:[(0,r.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-2 border-mingcare-blue border-t-transparent"}),(0,r.jsx)("p",{className:"text-sm text-text-secondary mt-3",children:"計算中..."})]}):n?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"card-apple border border-border-light p-6 text-center",children:[(0,r.jsxs)("div",{className:"text-3xl font-bold text-text-primary mb-2",children:["$",n.totalRevenue.toLocaleString()]}),(0,r.jsx)("div",{className:"text-sm text-text-secondary",children:"總收入"}),0!==n.revenueGrowthRate&&(0,r.jsxs)("div",{className:"text-xs mt-2 ".concat(n.revenueGrowthRate>=0?"text-green-600":"text-red-600"),children:[n.revenueGrowthRate>=0?"↗":"↘"," ",Math.abs(n.revenueGrowthRate).toFixed(1),"%"]})]}),(0,r.jsxs)("div",{className:"card-apple border border-border-light p-6 text-center",children:[(0,r.jsxs)("div",{className:"text-3xl font-bold text-text-primary mb-2",children:["$",n.totalProfit.toLocaleString()]}),(0,r.jsx)("div",{className:"text-sm text-text-secondary",children:"總利潤"}),(0,r.jsxs)("div",{className:"text-xs text-text-secondary mt-2",children:["利潤率: ",n.totalRevenue>0?(n.totalProfit/n.totalRevenue*100).toFixed(1):0,"%"]})]}),(0,r.jsxs)("div",{className:"card-apple border border-border-light p-6 text-center",children:[(0,r.jsx)("div",{className:"text-3xl font-bold text-text-primary mb-2",children:n.totalServiceHours.toFixed(1)}),(0,r.jsx)("div",{className:"text-sm text-text-secondary",children:"總服務時數"})]}),(0,r.jsxs)("div",{className:"card-apple border border-border-light p-6 text-center",children:[(0,r.jsxs)("div",{className:"text-3xl font-bold text-text-primary mb-2",children:["$",n.avgProfitPerHour.toFixed(2)]}),(0,r.jsx)("div",{className:"text-sm text-text-secondary",children:"每小時利潤"})]})]}):(0,r.jsx)("div",{className:"col-span-full text-center py-12",children:(0,r.jsx)("p",{className:"text-text-secondary",children:"選取的日期範圍內暫無數據"})})}),(0,r.jsx)("div",{className:"card-apple border border-border-light fade-in-apple",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h3",{className:"text-apple-heading text-text-primary mb-6",children:"項目分類統計"}),c.length>0?(0,r.jsxs)("div",{className:"space-y-4",children:[c.slice(0,5).map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 bg-bg-secondary rounded-lg border border-border-light",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-3 h-3 bg-mingcare-blue rounded-full mr-3"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium text-text-primary",children:e.category}),(0,r.jsxs)("p",{className:"text-sm text-text-secondary",children:[e.recordCount," 筆記錄 • ",e.uniqueCustomers," 位客戶"]})]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsxs)("div",{className:"text-lg font-bold text-text-primary",children:["$",e.totalFee.toLocaleString()]}),(0,r.jsxs)("div",{className:"text-sm text-text-secondary",children:[e.totalHours.toFixed(1),"h • 利潤 $",e.totalProfit.toLocaleString()]})]})]},e.category)),c.length>5&&(0,r.jsxs)("div",{className:"text-center text-sm text-text-secondary",children:["還有 ",c.length-5," 個項目，請到詳細報表查看"]})]}):(0,r.jsx)("div",{className:"text-center py-12",children:(0,r.jsx)("p",{className:"text-text-secondary",children:"選取的日期範圍內暫無項目數據"})})]})})]})}function _(e){let{filters:t}=e,[a,n]=(0,s.useState)(new Date),[l,c]=(0,s.useState)({}),[o,i]=(0,s.useState)(!1),[d,m]=(0,s.useState)(null),[x,u]=(0,s.useState)([]),[p,h]=(0,s.useState)(!1),[g,b]=(0,s.useState)(!1),[v,y]=(0,s.useState)({}),[j,_]=(0,s.useState)("all"),[N,w]=(0,s.useState)({isOpen:!1,schedule:null,dateStr:"",scheduleIndex:-1}),[C,D]=(0,s.useState)(null),M=()=>Object.values(v).reduce((e,t)=>e+t.length,0),F=()=>{let e=new Set;return Object.values(v).forEach(t=>{t.forEach(t=>{t.customer_name&&e.add(t.customer_name)})}),Array.from(e).sort()},L=()=>{if("all"===j)return v;let e={};return Object.entries(v).forEach(t=>{let[a,r]=t,s=r.filter(e=>e.customer_name===j);s.length>0&&(e[a]=s)}),e},R=async()=>{let e=L(),t=Object.values(e).reduce((e,t)=>e+t.length,0);if(0===t){"all"===j?alert("沒有待儲存的排程"):alert("沒有 ".concat(j," 的待儲存排程"));return}let a="all"===j?"全部":j;if(confirm("確定要儲存 ".concat(a," 的 ").concat(t," 個排程到資料庫嗎？")))try{for(let[t,a]of(b(!0),Object.entries(e)))for(let e of a){let t={customer_id:e.customer_id,care_staff_name:e.care_staff_name,service_date:e.service_date,start_time:e.start_time,end_time:e.end_time,service_type:e.service_type,service_address:e.service_address,hourly_rate:e.hourly_rate,service_fee:e.service_fee,staff_salary:e.staff_salary,phone:e.phone,customer_name:e.customer_name,service_hours:e.service_hours,hourly_salary:e.hourly_salary,project_category:e.project_category,project_manager:e.project_manager},a=await fetch("/api/billing-salary-management",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw Error("儲存排程失敗: ".concat(a.statusText))}"all"===j?y({}):y(t=>{let a={...t};return Object.keys(e).forEach(e=>{a[e]&&(a[e]=a[e].filter(e=>e.customer_name!==j),0===a[e].length&&delete a[e])}),a}),alert("成功儲存 ".concat(a," 的 ").concat(t," 個排程到資料庫！"))}catch(e){console.error("儲存本地排程失敗:",e),alert("儲存排程時發生錯誤，請稍後再試")}finally{b(!1)}},O=(e,t)=>{y(a=>{let r={...a};return r[e]&&(r[e]=r[e].filter((e,a)=>a!==t),0===r[e].length&&delete r[e]),r})},E=(e,t,a)=>{w({isOpen:!0,schedule:a,dateStr:e,scheduleIndex:t})},z=async e=>{b(!0);try{if(C){let{originalDateStr:t,originalIndex:a}=C,r=e.service_date;console.log("編輯排程 - 原日期:",t,"新日期:",r),y(s=>{let n={...s};return n[t]&&(n[t]=n[t].filter((e,t)=>t!==a),0===n[t].length&&delete n[t]),n[r]=[...n[r]||[],e],console.log("更新後的本地排程:",n),n}),alert("成功更新排班記錄"),D(null)}else if(x.length>1)x.forEach(t=>{let a={...e,service_date:t};y(e=>({...e,[t]:[...e[t]||[],a]}))}),alert("成功添加 ".concat(x.length," 筆排班記錄到月曆"));else{let t=e.service_date;y(a=>({...a,[t]:[...a[t]||[],e]})),alert("成功添加排班記錄到月曆")}i(!1),m(null),u([]),h(!1)}catch(e){console.error("處理排班失敗:",e),alert("處理排班失敗，請重試")}finally{b(!1)}},T=e=>{let t=new Date(a);t.setMonth(a.getMonth()+("next"===e?1:-1)),n(t)},I=e=>{let t=f(e);p?x.includes(t)?u(e=>e.filter(e=>e!==t)):u(e=>[...e,t]):(m(t),u([t]),i(!0))},P=(()=>{let e=new Date(a.getFullYear(),a.getMonth(),1),t=new Date(e);t.setDate(t.getDate()-e.getDay());let r=[],s=new Date(t);for(let e=0;e<42;e++)r.push(new Date(s)),s.setDate(s.getDate()+1);return r})(),B=a.getMonth();return(0,r.jsxs)("div",{className:"space-y-8",children:[(0,r.jsx)("div",{className:"card-apple border border-border-light fade-in-apple",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)("h3",{className:"text-apple-heading text-text-primary",children:"月曆排班"}),F().length>0&&(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("span",{className:"text-sm text-text-secondary",children:"顯示客戶:"}),(0,r.jsxs)("select",{value:j,onChange:e=>_(e.target.value),className:"px-3 py-1 text-sm border border-border-light rounded-lg bg-bg-primary text-text-primary focus:outline-none focus:ring-2 focus:ring-mingcare-blue focus:border-transparent",children:[(0,r.jsx)("option",{value:"all",children:"全部客戶"}),F().map(e=>(0,r.jsx)("option",{value:e,children:e},e))]})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[p&&x.length>0&&(0,r.jsxs)("div",{className:"text-sm text-text-secondary",children:["已選擇 ",x.length," 天"]}),M()>0&&(0,r.jsx)("div",{className:"text-sm text-orange-600 font-medium",children:"all"===j?"待儲存 ".concat(M()," 個排程"):"".concat(j,": ").concat(Object.values(L()).reduce((e,t)=>e+t.length,0)," 個排程")}),(0,r.jsx)("button",{onClick:()=>{h(!p),u([]),m(null)},className:"px-4 py-2 rounded-lg border transition-all duration-200 ".concat(p?"bg-mingcare-blue text-white border-mingcare-blue":"border-border-light hover:bg-bg-secondary text-text-secondary"),children:p?"取消多選":"多天排班"}),p&&x.length>0&&(0,r.jsx)("button",{onClick:()=>{i(!0)},className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200",children:"確認排班"}),M()>0&&(0,r.jsx)("button",{onClick:R,disabled:g,className:"px-4 py-2 rounded-lg transition-all duration-200 ".concat(g?"bg-gray-400 text-white cursor-not-allowed":"bg-orange-600 text-white hover:bg-orange-700"),children:g?"儲存中...":"all"===j?"確認儲存全部":"儲存 ".concat(j)})]})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("button",{onClick:()=>T("prev"),className:"p-2 rounded-lg border border-border-light hover:bg-bg-secondary transition-all duration-200",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsxs)("h4",{className:"text-lg font-medium text-text-primary",children:[a.getFullYear(),"年 ",a.getMonth()+1,"月 排班表"]}),(0,r.jsx)("button",{onClick:()=>T("next"),className:"p-2 rounded-lg border border-border-light hover:bg-bg-secondary transition-all duration-200",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),(0,r.jsx)("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["週日","週一","週二","週三","週四","週五","週六"].map(e=>(0,r.jsx)("div",{className:"p-3 text-center text-sm font-medium text-text-secondary bg-bg-secondary rounded-lg",children:e},e))}),(0,r.jsx)("div",{className:"grid grid-cols-7 gap-1",children:P.map((e,t)=>{let a=f(e),s=e.getMonth()===B,n=a===f(new Date),c=0===e.getDay()||6===e.getDay(),o=x.includes(a),i=l[a]||[],d=L()[a]||[],m=[...i,...d],u=m.length>0?Math.max(140,140+(m.length-1)*90):140;return(0,r.jsxs)("div",{onClick:()=>s&&I(e),style:{minHeight:"".concat(u,"px")},className:"\n                    p-2 border-2 rounded-lg cursor-pointer\n                    transition-all duration-200 hover:shadow-md\n                    ".concat(s?o?"bg-green-100 border-green-500 border-2":c?"bg-blue-50 border-blue-200":"bg-bg-primary border-border-light":"bg-gray-50 text-gray-300 border-gray-200","\n                    ").concat(n?"ring-2 ring-mingcare-blue border-mingcare-blue":"","\n                    hover:border-mingcare-blue\n                  "),children:[(0,r.jsxs)("div",{className:"\n                    text-lg font-bold mb-3 flex justify-between items-center\n                    ".concat(n?"text-mingcare-blue":s?"text-text-primary":"text-gray-300","\n                  "),children:[(0,r.jsx)("span",{children:e.getDate()}),s&&(0,r.jsx)("span",{className:"text-base text-green-600",children:"+"})]}),s&&(0,r.jsxs)("div",{className:"space-y-2",children:[i.map((e,t)=>(0,r.jsxs)("div",{className:"text-base bg-white border border-gray-200 rounded p-3 shadow-sm",children:[(0,r.jsxs)("div",{className:"font-medium text-gray-800 mb-2 text-base break-words leading-tight",children:[e.customer_name,"/",e.care_staff_name]}),(0,r.jsx)("div",{className:"text-blue-600 mb-2 text-base break-words leading-tight",children:e.service_type}),(0,r.jsxs)("div",{className:"text-gray-600 text-base font-medium",children:[e.start_time,"-",e.end_time]})]},"remote-".concat(t))),d.map((e,t)=>(0,r.jsxs)("div",{onClick:r=>{r.stopPropagation(),E(a,t,e)},className:"text-base bg-yellow-50 border-2 border-yellow-300 rounded p-3 shadow-sm cursor-pointer hover:bg-yellow-100 transition-colors relative group",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-blue-500 bg-opacity-0 group-hover:bg-opacity-20 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all",children:(0,r.jsx)("span",{className:"text-blue-700 font-bold text-sm",children:"點擊編輯"})}),(0,r.jsxs)("div",{className:"font-medium text-gray-800 mb-2 text-base break-words leading-tight",children:[e.customer_name,"/",e.care_staff_name]}),(0,r.jsx)("div",{className:"text-blue-600 mb-2 text-base break-words leading-tight",children:e.service_type}),(0,r.jsxs)("div",{className:"text-gray-600 text-base font-medium",children:[e.start_time,"-",e.end_time]})]},"local-".concat(t)))]})]},t)})})]})}),(0,r.jsx)("div",{className:"card-apple border border-border-light fade-in-apple",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h3",{className:"text-apple-heading text-text-primary mb-4",children:"排班說明"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-4 h-4 bg-blue-50 border-2 border-blue-200 rounded"}),(0,r.jsx)("span",{className:"text-text-secondary",children:"週末"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-4 h-4 bg-mingcare-blue rounded"}),(0,r.jsx)("span",{className:"text-text-secondary",children:"已安排服務"})]})]})]})}),o&&(0,r.jsx)(k,{isOpen:o,onClose:()=>{i(!1),m(null),u([]),h(!1),D(null)},selectedDate:d,selectedDates:x,existingRecord:(null==C?void 0:C.schedule)?{id:"local-edit",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),service_date:C.schedule.service_date,customer_id:C.schedule.customer_id,customer_name:C.schedule.customer_name,phone:C.schedule.phone,service_address:C.schedule.service_address,start_time:C.schedule.start_time,end_time:C.schedule.end_time,service_hours:C.schedule.service_hours,care_staff_name:C.schedule.care_staff_name,service_fee:C.schedule.service_fee,staff_salary:C.schedule.staff_salary,hourly_rate:C.schedule.hourly_rate,hourly_salary:C.schedule.hourly_salary,service_type:C.schedule.service_type,project_category:C.schedule.project_category,project_manager:C.schedule.project_manager}:null,onSubmit:z}),N.isOpen&&(0,r.jsx)(S,{isOpen:N.isOpen,schedule:N.schedule,onClose:()=>w({isOpen:!1,schedule:null,dateStr:"",scheduleIndex:-1}),onUpdate:e=>{let{dateStr:t,scheduleIndex:a}=N;y(r=>{let s={...r};return s[t]&&(s[t][a]=e),s}),w({isOpen:!1,schedule:null,dateStr:"",scheduleIndex:-1})},onDelete:()=>{let{dateStr:e,scheduleIndex:t}=N;O(e,t),w({isOpen:!1,schedule:null,dateStr:"",scheduleIndex:-1})},onEdit:()=>{let{dateStr:e,scheduleIndex:t,schedule:a}=N;a&&(console.log("開始編輯本地排程:",{originalDate:e,originalIndex:t,scheduleDate:a.service_date}),D({originalDateStr:e,originalIndex:t,schedule:a}),m(a.service_date),u([]),h(!1),w({isOpen:!1,schedule:null,dateStr:"",scheduleIndex:-1}),i(!0))}})]})}function N(e){let{filters:t,setFilters:a,updateDateRange:l,exportLoading:c,handleExport:d,reportsViewMode:m,setReportsViewMode:x,onEdit:u}=e,[p,h]=(0,s.useState)([]),[j,_]=(0,s.useState)(!0),[N,w]=(0,s.useState)(""),[k,S]=(0,s.useState)([]),[C,D]=(0,s.useState)(!1),[M,F]=(0,s.useState)(!1),[L,R]=(0,s.useState)([]),O=(0,s.useRef)(null),[E,z]=(0,s.useState)({top:0,left:0,width:0}),T=()=>{if(O.current){let e=O.current.getBoundingClientRect();z({top:e.bottom+window.scrollY,left:e.left+window.scrollX,width:e.width})}};(0,s.useEffect)(()=>{let e=e=>{e.target.closest(".customer-search-container")||D(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,s.useEffect)(()=>{I()},[]);let I=async()=>{try{_(!0);let e=await b();e.success&&e.data&&h(e.data)}catch(e){console.error("載入護理人員列表失敗:",e)}finally{_(!1)}},P=async e=>{if(console.log("客戶搜尋開始:",e),e.length<1){S([]),D(!1);return}try{F(!0);let t=await g(e);console.log("搜尋結果:",t),t.success&&t.data?(S(t.data),D(!0),console.log("設定建議列表:",t.data.length,"筆資料")):(S([]),D(!1))}catch(e){console.error("客戶搜尋失敗:",e),S([]),D(!1)}finally{F(!1)}},B=e=>{console.log("切換客戶選擇:",e.customer_name),R(t=>{let a;return t.some(t=>t.customer_id===e.customer_id)?(a=t.filter(t=>t.customer_id!==e.customer_id),console.log("移除客戶:",e.customer_name)):(a=[...t,e],console.log("新增客戶:",e.customer_name)),a})};(0,s.useEffect)(()=>{if(L.length>0){let e=L.map(e=>e.customer_id);a(t=>({...t,selectedCustomerIds:e,searchTerm:""})),console.log("設定客戶篩選條件:",e)}else a(e=>({...e,selectedCustomerIds:void 0,searchTerm:""})),console.log("清除客戶篩選條件")},[L]);let H=e=>{B(e)},Y=e=>{w(e),0===L.length&&a(t=>({...t,searchTerm:e})),e.length>=1?(T(),P(e)):(S([]),D(!1))};return(0,r.jsxs)("div",{className:"space-y-6 sm:space-y-8",children:[(0,r.jsx)("div",{className:"card-apple border border-border-light fade-in-apple",style:{overflow:"visible"},children:(0,r.jsxs)("div",{className:"p-4 sm:p-6",style:{overflow:"visible"},children:[(0,r.jsx)("h2",{className:"text-base sm:text-lg font-bold text-text-primary mb-4 sm:mb-6",children:"篩選條件"}),(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-4 sm:mb-6",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2 bg-white border border-border-light rounded-lg px-3 sm:px-4 py-2",children:[(0,r.jsx)("svg",{className:"w-3 h-3 sm:w-4 sm:h-4 text-text-secondary flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),(0,r.jsx)("input",{type:"date",value:t.dateRange.start,onChange:e=>a(t=>({...t,dateRange:{...t.dateRange,start:e.target.value}})),className:"border-none outline-none bg-transparent text-xs sm:text-sm min-w-0 flex-1"}),(0,r.jsx)("span",{className:"text-text-secondary text-xs sm:text-sm",children:"-"}),(0,r.jsx)("input",{type:"date",value:t.dateRange.end,onChange:e=>a(t=>({...t,dateRange:{...t.dateRange,end:e.target.value}})),className:"border-none outline-none bg-transparent text-xs sm:text-sm min-w-0 flex-1"})]}),(0,r.jsxs)("div",{className:"flex space-x-2",children:[(0,r.jsx)("button",{onClick:()=>{let e=f(new Date);a(t=>({...t,dateRange:{start:e,end:e}}))},className:"px-3 sm:px-4 py-2 text-xs sm:text-sm border border-border-light rounded-lg hover:bg-bg-secondary transition-all duration-200 whitespace-nowrap",children:"今日"}),(0,r.jsx)("button",{onClick:()=>l("thisMonth"),className:"px-3 sm:px-4 py-2 text-xs sm:text-sm border border-border-light rounded-lg bg-mingcare-blue text-white whitespace-nowrap",children:"本月"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6 relative",children:[(0,r.jsxs)("div",{className:"relative z-20 overflow-visible sm:col-span-2 lg:col-span-1",children:[(0,r.jsxs)("div",{className:"relative customer-search-container overflow-visible",children:[(0,r.jsx)("svg",{className:"absolute left-3 top-3 w-3 h-3 sm:w-4 sm:h-4 text-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),(0,r.jsx)("input",{ref:O,type:"text",placeholder:"搜尋客戶",value:N,onChange:e=>Y(e.target.value),onFocus:()=>{console.log("輸入框被點擊"),T(),N.length>=1&&(k.length>0?D(!0):P(N))},onBlur:()=>{console.log("輸入框失去焦點"),setTimeout(()=>{D(!1)},150)},className:"w-full pl-8 sm:pl-10 pr-3 sm:pr-4 py-2 sm:py-3 border border-border-light rounded-lg focus:ring-2 focus:ring-mingcare-blue focus:border-transparent text-xs sm:text-sm"}),C&&(0,n.createPortal)((0,r.jsx)("div",{className:"fixed bg-white border border-border-light rounded-lg shadow-2xl max-h-48 overflow-y-auto z-[9999]",style:{top:"".concat(E.top,"px"),left:"".concat(E.left,"px"),width:"".concat(E.width,"px"),backgroundColor:"#ffffff",border:"1px solid #e5e7eb"},onMouseDown:e=>{console.log("下拉選單被點擊"),e.preventDefault()},children:M?(0,r.jsx)("div",{className:"p-3 text-center text-text-secondary",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-mingcare-blue border-t-transparent mx-auto"})}):k.length>0?k.map((e,t)=>(0,r.jsxs)("div",{className:"p-3 hover:bg-bg-secondary cursor-pointer border-b border-border-light last:border-b-0 flex items-center transition-colors",onMouseDown:t=>{console.log("選項被點擊:",e.customer_name),t.preventDefault(),t.stopPropagation(),B(e)},children:[(0,r.jsx)("input",{type:"checkbox",checked:L.some(t=>t.customer_id===e.customer_id),className:"mr-3 rounded border-border-light focus:ring-mingcare-blue pointer-events-none",readOnly:!0}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("div",{className:"font-medium text-text-primary",children:e.customer_name}),(0,r.jsxs)("div",{className:"text-sm text-text-secondary",children:[e.customer_id," ",e.phone&&"• ".concat(e.phone)]})]})]},"".concat(e.customer_id,"-").concat(t))):(0,r.jsx)("div",{className:"p-3 text-center text-text-secondary text-sm",children:"沒有找到相關客戶"})}),document.body)]}),L.length>0&&(0,r.jsx)("div",{className:"mt-2 flex flex-wrap gap-2",children:L.map(e=>(0,r.jsxs)("div",{className:"inline-flex items-center bg-mingcare-blue text-white text-sm px-3 py-1 rounded-full",children:[(0,r.jsxs)("span",{className:"mr-2",children:[e.customer_name," (",e.customer_id,")"]}),(0,r.jsx)("button",{onClick:()=>H(e),className:"hover:bg-white hover:bg-opacity-20 rounded-full p-1",children:(0,r.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.customer_id))})]}),(0,r.jsx)("div",{className:"sm:col-span-2 lg:col-span-1",children:(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsxs)("select",{value:t.projectCategory||"",onChange:e=>a(t=>({...t,projectCategory:e.target.value})),className:"w-full px-3 sm:px-4 py-2 sm:py-3 border border-border-light rounded-lg focus:ring-2 focus:ring-mingcare-blue focus:border-transparent appearance-none bg-white pr-8 sm:pr-10 text-xs sm:text-sm",children:[(0,r.jsx)("option",{value:"",children:"選擇所屬項目"}),i.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))]}),(0,r.jsx)("svg",{className:"absolute right-2 sm:right-3 top-1/2 transform -translate-y-1/2 w-3 h-3 sm:w-4 sm:h-4 text-text-secondary pointer-events-none",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})}),(0,r.jsx)("div",{className:"sm:col-span-2 lg:col-span-1",children:(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsxs)("select",{value:t.serviceType||"",onChange:e=>a(t=>({...t,serviceType:e.target.value})),className:"w-full px-3 sm:px-4 py-2 sm:py-3 border border-border-light rounded-lg focus:ring-2 focus:ring-mingcare-blue focus:border-transparent appearance-none bg-white pr-8 sm:pr-10 text-xs sm:text-sm",children:[(0,r.jsx)("option",{value:"",children:"選擇服務類型"}),o.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))]}),(0,r.jsx)("svg",{className:"absolute right-2 sm:right-3 top-1/2 transform -translate-y-1/2 w-3 h-3 sm:w-4 sm:h-4 text-text-secondary pointer-events-none",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})}),(0,r.jsx)("div",{className:"sm:col-span-2 lg:col-span-1",children:(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsxs)("select",{value:t.careStaffName||"",onChange:e=>a(t=>({...t,careStaffName:e.target.value})),className:"w-full px-3 sm:px-4 py-2 sm:py-3 border border-border-light rounded-lg focus:ring-2 focus:ring-mingcare-blue focus:border-transparent appearance-none bg-white pr-8 sm:pr-10 text-xs sm:text-sm",disabled:j,children:[(0,r.jsx)("option",{value:"",children:j?"載入中...":"選擇護理人員"}),p.map((e,t)=>(0,r.jsx)("option",{value:e.name_chinese,children:e.name_chinese},t))]}),(0,r.jsx)("svg",{className:"absolute right-2 sm:right-3 top-1/2 transform -translate-y-1/2 w-3 h-3 sm:w-4 sm:h-4 text-text-secondary pointer-events-none",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})})]})]})}),(0,r.jsx)("div",{className:"card-apple border border-border-light fade-in-apple",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h3",{className:"text-apple-heading text-text-primary",children:"服務記錄列表"}),(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4",children:[(0,r.jsxs)("div",{className:"flex items-center border border-border-light rounded-lg p-1",children:[(0,r.jsxs)("button",{onClick:()=>x("list"),className:"px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium transition-all duration-200 flex items-center space-x-1 sm:space-x-2 ".concat("list"===m?"bg-mingcare-blue text-white":"text-text-secondary hover:text-text-primary hover:bg-bg-secondary"),children:[(0,r.jsx)("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 10h16M4 14h16M4 18h16"})}),(0,r.jsx)("span",{children:"列表"})]}),(0,r.jsxs)("button",{onClick:()=>x("calendar"),className:"px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium transition-all duration-200 flex items-center space-x-1 sm:space-x-2 ".concat("calendar"===m?"bg-mingcare-blue text-white":"text-text-secondary hover:text-text-primary hover:bg-bg-secondary"),children:[(0,r.jsx)("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),(0,r.jsx)("span",{children:"月曆"})]})]}),(0,r.jsx)("button",{onClick:d,disabled:c,className:"px-4 sm:px-6 py-2 sm:py-3 bg-mingcare-blue text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2 text-xs sm:text-sm",children:c?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-3 w-3 sm:h-4 sm:w-4 border-2 border-white border-t-transparent"}),(0,r.jsx)("span",{children:"導出中..."})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,r.jsx)("span",{children:"導出報表"})]})})]})]}),"list"===m?(0,r.jsx)(y,{filters:t}):(0,r.jsx)(v,{filters:t,onEdit:u})]})})]})}function w(){let[e,t]=(0,s.useState)(null),[a,n]=(0,s.useState)(!0),[o,i]=(0,s.useState)(!1),[d,x]=(0,s.useState)(!1),[u,g]=(0,s.useState)("reports"),[b,f]=(0,s.useState)("list"),v=(0,l.useRouter)(),[y,w]=(0,s.useState)(()=>{let e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0),r=e=>{let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(a,"-").concat(r)};return{dateRange:{start:r(t),end:r(a)}}}),[S,C]=(0,s.useState)(null),[D,M]=(0,s.useState)([]),[F,L]=(0,s.useState)(null),[R,O]=(0,s.useState)(!1),[E,z]=(0,s.useState)(!1),[T,I]=(0,s.useState)("pdf"),[P,B]=(0,s.useState)("accounting"),[H,Y]=(0,s.useState)("combined"),[W,V]=(0,s.useState)(!1),[A,$]=(0,s.useState)({}),[q,J]=(0,s.useState)([]),[U,G]=(0,s.useState)(!0),[K,Z]=(0,s.useState)({service_date:!0,customer_id:!1,customer_name:!0,phone:!1,service_address:!0,start_time:!0,end_time:!0,service_hours:!0,care_staff_name:!0,service_fee:!1,staff_salary:!1,hourly_rate:!1,hourly_salary:!1,service_type:!0,project_category:!1,project_manager:!1}),X={accounting:{name:"對數模式",description:"包含服務費用和收費相關欄位",columns:{service_date:!0,customer_name:!0,service_address:!0,start_time:!0,end_time:!0,service_hours:!0,care_staff_name:!0,service_type:!0,service_fee:!0,hourly_rate:!0,customer_id:!1,phone:!1,staff_salary:!1,hourly_salary:!1,project_category:!1,project_manager:!1}},payroll:{name:"工資模式",description:"包含護理員工資和薪酬相關欄位",columns:{service_date:!0,customer_name:!0,service_address:!0,start_time:!0,end_time:!0,service_hours:!0,care_staff_name:!1,service_type:!0,staff_salary:!0,hourly_salary:!0,customer_id:!1,phone:!1,service_fee:!1,hourly_rate:!1,project_category:!1,project_manager:!1}}};(0,s.useEffect)(()=>{(async()=>{let{data:{user:e}}=await c.O.auth.getUser();e?t(e):v.push("/"),n(!1)})()},[v]),(0,s.useEffect)(()=>{e&&"overview"===u&&Q()},[e,y.dateRange,u]);let Q=async()=>{i(!0);try{let e=await p({start:y.dateRange.start,end:y.dateRange.end});e.success&&e.data&&C(e.data);let t=await h({start:y.dateRange.start,end:y.dateRange.end});t.success&&t.data&&M(t.data)}catch(e){console.error("載入數據失敗:",e)}finally{i(!1)}};(0,s.useEffect)(()=>{W&&(async()=>{G(!0);try{let e=await m(y,1,1e4);if(e.success&&e.data){let t=Array.from(new Set(e.data.data.filter(e=>e.care_staff_name&&""!==e.care_staff_name.trim()).map(e=>e.care_staff_name))).sort();J(t)}}catch(e){console.error("載入護理員列表失敗:",e)}finally{G(!1)}})()},[W,y]);let ee=e=>{let t,a;let r=new Date;switch(e){case"last7days":t=new Date(r.getTime()-6048e5),a=r;break;case"last30days":t=new Date(r.getTime()-2592e6),a=r;break;case"last90days":t=new Date(r.getTime()-7776e6),a=r;break;case"thisMonth":t=new Date(r.getFullYear(),r.getMonth(),1),a=new Date(r.getFullYear(),r.getMonth()+1,0);break;case"lastMonth":t=new Date(r.getFullYear(),r.getMonth()-1,1),a=new Date(r.getFullYear(),r.getMonth(),0);break;default:return}let s=e=>{let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(a,"-").concat(r)};w(e=>({...e,dateRange:{start:s(t),end:s(a)}}))},et=e=>{B(e),Z(X[e].columns)},ea=async()=>{x(!0),z(!1);try{let e=await m(y,1,1e4);if(!e.success||!e.data)throw Error("無法獲取數據");let t=e.data.data;"accounting"===P&&(t=t.sort((e,t)=>{let a=(e.customer_name||"").localeCompare(t.customer_name||"","zh-TW");if(0!==a)return a;let r=new Date(e.service_date||""),s=new Date(t.service_date||"");return r.getTime()-s.getTime()}));let a=Object.entries(K).filter(e=>{let[t,a]=e;return a}).map(e=>{let[t,a]=e;return t});"pdf"===T?"payroll"===P&&"separate"===H?(z(!1),V(!0),$({})):await en(t,a):await el(t,a),alert("導出成功")}catch(e){console.error("Export error:",e),alert("導出時發生錯誤")}finally{x(!1)}},er=async(e,t,a)=>{try{let r=t.filter(t=>(t.care_staff_name||"未知護理人員")===e);if(0===r.length){alert("該護理員沒有記錄");return}r.sort((e,t)=>new Date(e.service_date).getTime()-new Date(t.service_date).getTime()),await es(r,a,e),$(t=>({...t,[e]:"downloaded"}))}catch(e){console.error("下載護理員PDF時發生錯誤:",e),alert("下載護理員PDF時發生錯誤")}},es=async(e,t,a)=>{let r={service_date:"服務日期",customer_id:"客戶編號",customer_name:"客戶姓名",phone:"客戶電話",service_address:"服務地址",start_time:"開始時間",end_time:"結束時間",service_hours:"服務時數",care_staff_name:"護理員姓名",service_fee:"服務費用",staff_salary:"護理員工資",hourly_rate:"每小時收費",hourly_salary:"每小時工資",service_type:"服務類型",project_category:"所屬項目",project_manager:"項目經理",service_time:"服務時間",duration_hours:"時數",billing_amount:"金額",customer_address:"客戶地址",notes:"備註"},s=e.length,n=e.reduce((e,t)=>{let a=parseFloat(t.service_hours||t.duration_hours||"0");return e+(isNaN(a)?0:a)},0),l=e.reduce((e,t)=>{let a=parseFloat(t.staff_salary||t.billing_amount||"0");return e+(isNaN(a)?0:a)},0),c=new Date,o="".concat(c.getFullYear(),"-").concat(String(c.getMonth()+1).padStart(2,"0"),"-").concat(String(c.getDate()).padStart(2,"0")),i=e[0],d=new Date((null==i?void 0:i.service_date)||c),m="".concat(d.getFullYear(),"-").concat(String(d.getMonth()+1).padStart(2,"0")),x='\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset="UTF-8">\n        <title>'.concat(a," ").concat(m,'工資明細</title>\n        <style>\n          @page {\n            size: A4 landscape;\n            margin: 20mm;\n          }\n          body {\n            font-family: "PingFang TC", "Microsoft JhengHei", "SimHei", sans-serif;\n            margin: 0;\n            padding: 20px;\n            font-size: 12px;\n          }\n          .header {\n            text-align: center;\n            margin-bottom: 30px;\n          }\n          .title {\n            font-size: 18px;\n            font-weight: bold;\n            margin-bottom: 10px;\n          }\n          .subtitle {\n            font-size: 14px;\n            margin-bottom: 5px;\n          }\n          .summary {\n            margin-bottom: 20px;\n          }\n          table {\n            width: 100%;\n            border-collapse: collapse;\n            margin-top: 20px;\n          }\n          th, td {\n            border: 1px solid #ddd;\n            padding: 8px;\n            text-align: left;\n            font-size: 11px;\n          }\n          th {\n            background-color: #f2f2f2;\n            font-weight: bold;\n          }\n          tr:nth-child(even) {\n            background-color: #f9f9f9;\n          }\n          .summary-section {\n            margin-top: 30px;\n            padding: 15px;\n            background-color: #f8f9fa;\n            border: 2px solid #dee2e6;\n            border-radius: 5px;\n          }\n          .summary-title {\n            font-size: 16px;\n            font-weight: bold;\n            margin-bottom: 15px;\n            text-align: center;\n            color: #495057;\n          }\n          .summary-item {\n            display: flex;\n            justify-content: space-between;\n            margin-bottom: 8px;\n            font-size: 14px;\n          }\n          .summary-item strong {\n            color: #495057;\n          }\n          .summary-total {\n            border-top: 2px solid #dee2e6;\n            padding-top: 10px;\n            margin-top: 10px;\n            font-weight: bold;\n            font-size: 15px;\n            color: #007bff;\n          }\n        </style>\n      </head>\n      <body>\n        <div class="header">\n          <div class="title">').concat(a," ").concat(m,' 工資明細</div>\n          <div class="subtitle">匯出日期: ').concat(o,"</div>\n        </div>\n        \n        <table>\n          <thead>\n            <tr>\n              ").concat(t.map(e=>"<th>".concat(r[e]||e,"</th>")).join(""),"\n            </tr>\n          </thead>\n          <tbody>\n            ").concat(e.map(e=>"\n              <tr>\n                ".concat(t.map(t=>{let a="";switch(t){case"service_date":let r=new Date(e[t]);a="".concat(r.getFullYear(),"-").concat(String(r.getMonth()+1).padStart(2,"0"),"-").concat(String(r.getDate()).padStart(2,"0"));break;case"start_time":case"end_time":let s=e[t]||"";if(s.includes("T")||s.includes(" ")){let e=new Date(s);a="".concat(String(e.getHours()).padStart(2,"0"),":").concat(String(e.getMinutes()).padStart(2,"0"))}else a=s;break;case"service_hours":case"duration_hours":let n=parseFloat(e[t]||"0");a=isNaN(n)?"0":n.toString();break;case"staff_salary":case"service_fee":case"hourly_rate":case"hourly_salary":case"billing_amount":let l=parseFloat(e[t]||"0");a=isNaN(l)?"$0.00":"$".concat(l.toFixed(2));break;default:a=String(e[t]||"")}return"<td>".concat(a,"</td>")}).join(""),"\n              </tr>\n            ")).join(""),'\n          </tbody>\n        </table>\n\n        <!-- 總結部分 -->\n        <div class="summary-section">\n          <div class="summary-title">工資總結</div>\n          <div class="summary-item">\n            <span><strong>服務次數:</strong></span>\n            <span>').concat(s,' 次</span>\n          </div>\n          <div class="summary-item">\n            <span><strong>總時數:</strong></span>\n            <span>').concat(n.toFixed(1),' 小時</span>\n          </div>\n          <div class="summary-item summary-total">\n            <span><strong>總工資:</strong></span>\n            <span>$').concat(l.toFixed(2),"</span>\n          </div>\n        </div>\n      </body>\n      </html>\n    "),u=window.open("","_blank");u&&(u.document.write(x),u.document.close(),u.addEventListener("load",()=>{setTimeout(()=>{u.print(),u.close()},500)}))},en=async(e,t)=>{try{let a={service_date:"服務日期",customer_id:"客戶編號",customer_name:"客戶姓名",phone:"客戶電話",service_address:"服務地址",start_time:"開始時間",end_time:"結束時間",service_hours:"服務時數",care_staff_name:"護理員姓名",service_fee:"服務費用",staff_salary:"護理員工資",hourly_rate:"每小時收費",hourly_salary:"每小時工資",service_type:"服務類型",project_category:"所屬項目",project_manager:"項目經理"},r="accounting"===P,s="",n="";if(r){let r={};e.forEach(e=>{let t=e.customer_name||"未知客戶";r[t]||(r[t]=[]),r[t].push(e)});let l=Object.keys(r).length,c=e.length,o=0,i=0;s=Object.keys(r).map((e,s)=>{let n=r[e],l=0,c=0,d=n.map(e=>(l+=parseFloat(e.service_hours||"0"),c+=parseFloat(e.service_fee||"0"),"\n              <tr>\n                ".concat(t.map(t=>{let a=e[t]||"",r=["hourly_rate","hourly_salary","service_hours","service_fee","staff_salary"].includes(t);return'<td class="'.concat(r?"number":"",'">').concat(String(a),"</td>")}).join(""),"\n              </tr>\n            "))).join(""),m='\n            <tr class="customer-subtotal">\n              <td colspan="'.concat(t.length-2,'" style="text-align: right; font-weight: bold; background-color: #f0f8ff; border-top: 2px solid #428bca;">\n                ').concat(e,' 小結：\n              </td>\n              <td style="text-align: right; font-weight: bold; background-color: #f0f8ff; border-top: 2px solid #428bca;">\n                ').concat(l.toFixed(1),'\n              </td>\n              <td style="text-align: right; font-weight: bold; background-color: #f0f8ff; border-top: 2px solid #428bca;">\n                $').concat(c.toFixed(2),"\n              </td>\n            </tr>\n          ");return o+=l,i+=c,'\n            <div class="customer-group">\n              <h3 style="color: #428bca; margin: 20px 0 10px 0; font-size: 16px; border-bottom: 1px solid #428bca; padding-bottom: 5px;">\n                '.concat(e," (").concat(n.length," 次服務)\n              </h3>\n              <table>\n                <thead>\n                  <tr>\n                    ").concat(t.map(e=>"<th>".concat(a[e]||e,"</th>")).join(""),"\n                  </tr>\n                </thead>\n                <tbody>\n                  ").concat(d,"\n                  ").concat(m,"\n                </tbody>\n              </table>\n            </div>\n          ")}).join(""),n='\n          <div style="margin-top: 30px; padding: 20px; border: 2px solid #428bca; background-color: #f8f9fa; page-break-inside: avoid;">\n            <h3 style="text-align: center; color: #428bca; margin-bottom: 15px;">總結報告</h3>\n            <div style="display: flex; justify-content: space-around; font-size: 14px;">\n              <div style="text-align: center;">\n                <div style="font-weight: bold; color: #428bca;">客戶總數</div>\n                <div style="font-size: 18px; font-weight: bold;">'.concat(l,'</div>\n              </div>\n              <div style="text-align: center;">\n                <div style="font-weight: bold; color: #428bca;">服務次數</div>\n                <div style="font-size: 18px; font-weight: bold;">').concat(c,'</div>\n              </div>\n              <div style="text-align: center;">\n                <div style="font-weight: bold; color: #428bca;">總服務時數</div>\n                <div style="font-size: 18px; font-weight: bold;">').concat(o.toFixed(1),'</div>\n              </div>\n              <div style="text-align: center;">\n                <div style="font-weight: bold; color: #428bca;">總服務費用</div>\n                <div style="font-size: 18px; font-weight: bold;">$').concat(i.toFixed(2),"</div>\n              </div>\n            </div>\n          </div>\n        ")}else if("payroll"===P){let r={};e.forEach(e=>{let t=e.care_staff_name||"未知護理人員";r[t]||(r[t]=[]),r[t].push(e)});let l=Object.keys(r).sort(),c=Object.keys(r).length,o=e.length,i=0,d=0;s=l.map((e,s)=>{let n=r[e];n.sort((e,t)=>new Date(e.service_date).getTime()-new Date(t.service_date).getTime());let l=0,c=0;return n.forEach(e=>{let t=parseFloat(e.service_hours||e.duration_hours||"0"),a=parseFloat(e.staff_salary||"0");l+=isNaN(t)?0:t,c+=isNaN(a)?0:a}),i+=l,d+=c,'\n            <div class="staff-group">\n              <div class="staff-header">\n                <h2>'.concat(e,'</h2>\n                <div class="staff-info">記錄數: ').concat(n.length,'筆</div>\n              </div>\n              \n              <table class="data-table">\n                <thead>\n                  <tr>\n                    ').concat(t.map(e=>"<th>".concat(a[e]||e,"</th>")).join(""),"\n                  </tr>\n                </thead>\n                <tbody>\n                  ").concat(n.map(e=>"\n                    <tr>\n                      ".concat(t.map(t=>{let a=e[t]||"",r=["hourly_rate","hourly_salary","service_hours","duration_hours","service_fee","staff_salary"].includes(t),s=String(a);if("service_date"===t&&a){let e=new Date(a),t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");s="".concat(t,"-").concat(r,"-").concat(n)}else if(r&&a){let e=parseFloat(a);s=isNaN(e)?"0":e.toFixed(2)}return'<td class="'.concat(r?"number":"",'">').concat(s,"</td>")}).join(""),"\n                    </tr>\n                  ")).join(""),'\n                </tbody>\n              </table>\n              \n              <div class="staff-summary">\n                <div class="summary-row">\n                  <div class="summary-item">\n                    <span class="label">服務時數:</span>\n                    <span class="value">').concat(l.toFixed(1),' 小時</span>\n                  </div>\n                  <div class="summary-item">\n                    <span class="label">護理員工資:</span>\n                    <span class="value">$').concat(c.toFixed(2),"</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          ")}).join(""),n='\n          <div class="total-summary-page">\n            <div class="summary-header">\n              <h2>工資總結</h2>\n            </div>\n            <div class="summary-stats">\n              <div class="stat-row">\n                <div class="stat-item">\n                  <div class="stat-label">護理員數量</div>\n                  <div class="stat-value">'.concat(c,' 人</div>\n                </div>\n                <div class="stat-item">\n                  <div class="stat-label">總服務時數</div>\n                  <div class="stat-value">').concat(i.toFixed(1),' 小時</div>\n                </div>\n                <div class="stat-item">\n                  <div class="stat-label">總工資</div>\n                  <div class="stat-value">$').concat(d.toFixed(2),'</div>\n                </div>\n              </div>\n            </div>\n            \n            <div class="staff-summary-table">\n              <h3>各護理人員明細</h3>\n              <table class="summary-table">\n                <thead>\n                  <tr>\n                    <th>護理人員</th>\n                    <th>服務次數</th>\n                    <th>服務時數</th>\n                    <th>工資</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ').concat(l.map(e=>{let t=r[e],a=t.reduce((e,t)=>{let a=parseFloat(t.service_hours||t.duration_hours||"0");return e+(isNaN(a)?0:a)},0),s=t.reduce((e,t)=>{let a=parseFloat(t.staff_salary||"0");return e+(isNaN(a)?0:a)},0);return"\n                      <tr>\n                        <td>".concat(e,'</td>\n                        <td class="number">').concat(t.length,'</td>\n                        <td class="number">').concat(a.toFixed(1),'</td>\n                        <td class="number">$').concat(s.toFixed(2),"</td>\n                      </tr>\n                    ")}).join(""),'\n                  <tr class="total-row">\n                    <td><strong>總計</strong></td>\n                    <td class="number"><strong>').concat(o,'</strong></td>\n                    <td class="number"><strong>').concat(i.toFixed(1),'</strong></td>\n                    <td class="number"><strong>$').concat(d.toFixed(2),"</strong></td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n          </div>\n        ")}else s=e.map(e=>"\n          <tr>\n            ".concat(t.map(t=>{let a=e[t]||"",r=["hourly_rate","hourly_salary","service_hours","service_fee","staff_salary"].includes(t);return'<td class="'.concat(r?"number":"",'">').concat(String(a),"</td>")}).join(""),"\n          </tr>\n        ")).join("");let l='\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset="UTF-8">\n          <title>明家居家護理服務記錄報表</title>\n          <style>\n            @media print {\n              @page {\n                size: A4 portrait;\n                margin: 10mm;\n              }\n              body { margin: 0; }\n              .customer-group {\n                page-break-inside: avoid;\n                page-break-after: always;\n              }\n              .customer-group:last-child {\n                page-break-after: auto;\n              }\n              .staff-group {\n                page-break-inside: avoid;\n                page-break-after: always;\n              }\n              .staff-group:last-child {\n                page-break-after: auto;\n              }\n              .total-summary-page {\n                page-break-before: always;\n              }\n            }\n            body {\n              font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微軟雅黑", Arial, sans-serif;\n              font-size: 12px;\n              line-height: 1.4;\n              margin: 0;\n              padding: 10px;\n            }\n            .header {\n              text-align: center;\n              margin-bottom: 20px;\n              border-bottom: 2px solid #333;\n              padding-bottom: 10px;\n            }\n            .header h1 {\n              margin: 0;\n              font-size: 18px;\n              color: #333;\n            }\n            .header h2 {\n              margin: 5px 0;\n              font-size: 14px;\n              color: #666;\n            }\n            .meta {\n              text-align: center;\n              margin: 10px 0;\n              font-size: 11px;\n              color: #888;\n            }\n            table {\n              width: 100%;\n              border-collapse: collapse;\n              margin: 10px 0;\n              font-size: 12px;\n            }\n            th, td {\n              border: 1px solid #ddd;\n              padding: 5px 8px;\n              text-align: left;\n              word-wrap: break-word;\n            }\n            th {\n              background-color: #428bca;\n              color: white;\n              font-weight: bold;\n              text-align: center;\n              font-size: 13px;\n            }\n            tr:nth-child(even) {\n              background-color: #f8f9fa;\n            }\n            .number {\n              text-align: right;\n            }\n            .customer-subtotal {\n              background-color: #f0f8ff !important;\n            }\n            .staff-group {\n              margin-bottom: 30px;\n            }\n            .staff-header {\n              background-color: #e8f4fd;\n              padding: 15px;\n              border-radius: 8px;\n              margin-bottom: 15px;\n              border-left: 4px solid #428bca;\n            }\n            .staff-header h2 {\n              margin: 0;\n              color: #2c5282;\n              font-size: 18px;\n            }\n            .staff-info {\n              color: #666;\n              font-size: 14px;\n              margin-top: 5px;\n            }\n            .staff-summary {\n              background-color: #f8f9fa;\n              padding: 15px;\n              border-radius: 8px;\n              margin-top: 15px;\n              border: 1px solid #e0e0e0;\n            }\n            .summary-row {\n              display: flex;\n              justify-content: space-around;\n              align-items: center;\n            }\n            .summary-item {\n              text-align: center;\n              flex: 1;\n            }\n            .summary-item .label {\n              display: block;\n              font-weight: bold;\n              color: #666;\n              font-size: 13px;\n              margin-bottom: 5px;\n            }\n            .summary-item .value {\n              display: block;\n              font-size: 16px;\n              font-weight: bold;\n              color: #2c5282;\n            }\n            .total-summary-page {\n              padding: 20px;\n            }\n            .summary-header {\n              text-align: center;\n              margin-bottom: 30px;\n              border-bottom: 2px solid #428bca;\n              padding-bottom: 15px;\n            }\n            .summary-header h2 {\n              margin: 0;\n              color: #2c5282;\n              font-size: 24px;\n            }\n            .summary-stats {\n              margin-bottom: 30px;\n              background-color: #f8f9fa;\n              padding: 20px;\n              border-radius: 8px;\n            }\n            .stat-row {\n              display: flex;\n              justify-content: space-around;\n              align-items: center;\n            }\n            .stat-item {\n              text-align: center;\n              flex: 1;\n            }\n            .stat-label {\n              font-weight: bold;\n              color: #666;\n              font-size: 14px;\n              margin-bottom: 8px;\n            }\n            .stat-value {\n              font-size: 20px;\n              font-weight: bold;\n              color: #2c5282;\n            }\n            .staff-summary-table h3 {\n              color: #2c5282;\n              margin-bottom: 15px;\n              font-size: 18px;\n            }\n            .summary-table {\n              margin-top: 0;\n            }\n            .total-row {\n              background-color: #e8f4fd !important;\n              font-weight: bold;\n            }\n            .footer {\n              margin-top: 15px;\n              text-align: center;\n              font-size: 10px;\n              color: #666;\n              border-top: 1px solid #ddd;\n              padding-top: 10px;\n            }\n            @media screen {\n              .print-button {\n                position: fixed;\n                top: 20px;\n                right: 20px;\n                background: #007bff;\n                color: white;\n                border: none;\n                padding: 10px 20px;\n                border-radius: 5px;\n                cursor: pointer;\n                font-size: 14px;\n                z-index: 1000;\n              }\n              .print-button:hover {\n                background: #0056b3;\n              }\n            }\n            @media print {\n              .print-button { display: none; }\n            }\n          </style>\n        </head>\n        <body>\n          <button class="print-button" onclick="window.print()">列印 / 儲存為PDF</button>\n          \n          <div class="header">\n            <h1>MingCare Home Health Services Limited</h1>\n            <h2>明家居家護理服務記錄報表</h2>\n            '.concat(r?'<div style="color: #428bca; font-weight: bold; margin-top: 5px;">對數模式</div>':"","\n            ").concat("payroll"===P?'<div style="color: #28a745; font-weight: bold; margin-top: 5px;">工資模式</div>':"",'\n          </div>\n          \n          <div class="meta">\n            日期範圍: ').concat(y.dateRange.start," ~ ").concat(y.dateRange.end,"<br>\n            生成時間: ").concat(new Date().toLocaleDateString("zh-TW")," ").concat(new Date().toLocaleTimeString("zh-TW"),"\n          </div>\n          \n          ").concat(r||"payroll"===P?s:"\n          <table>\n            <thead>\n              <tr>\n                ".concat(t.map(e=>"<th>".concat(a[e]||e,"</th>")).join(""),"\n              </tr>\n            </thead>\n            <tbody>\n              ").concat(s,"\n            </tbody>\n          </table>\n          "),"\n          \n          ").concat(n,'\n          \n          <div class="footer">\n            <strong>明家居家護理服務有限公司 MingCare Home Health Services Limited</strong><br>\n            此報表由系統自動生成，如有疑問請聯繫管理員<br>\n            報表包含 ').concat(e.length," 筆記錄，共 ").concat(t.length," 個欄位\n          </div>\n        </body>\n        </html>\n      "),c=window.open("","_blank");if(c)c.document.write(l),c.document.close(),c.onload=()=>{setTimeout(()=>{c.focus()},500)};else{let e=new Blob([l],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="mingcare_report_".concat(y.dateRange.start,"_").concat(y.dateRange.end,".html"),document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(t),alert("已下載HTML文件，請在瀏覽器中打開後列印或儲存為PDF")}}catch(e){throw console.error("PDF導出錯誤:",e),alert("PDF導出失敗，請稍後再試或選擇CSV格式"),e}},el=async(e,t)=>{let a={service_date:"服務日期",customer_id:"客戶編號",customer_name:"客戶姓名",phone:"客戶電話",service_address:"服務地址",start_time:"開始時間",end_time:"結束時間",service_hours:"服務時數",care_staff_name:"護理員姓名",service_fee:"服務費用",staff_salary:"護理員工資",hourly_rate:"每小時收費",hourly_salary:"每小時工資",service_type:"服務類型",project_category:"所屬項目",project_manager:"項目經理"},r=new Blob(["\uFEFF"+[t.map(e=>a[e]||e).join(","),...e.map(e=>t.map(t=>{let a=String(e[t]||"");return a.includes(",")||a.includes('"')||a.includes("\n")?'"'.concat(a.replace(/"/g,'""'),'"'):a}).join(","))].join("\n")],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),n=URL.createObjectURL(r);s.setAttribute("href",n),s.setAttribute("download","mingcare_report_".concat(y.dateRange.start,"_").concat(y.dateRange.end,".csv")),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)},ec=async e=>{if(F)try{O(!1),L(null),alert("記錄已更新")}catch(e){console.error("更新記錄失敗:",e),alert("更新失敗")}},eo=async e=>{try{O(!1),L(null),alert("記錄已刪除")}catch(e){throw console.error("刪除記錄失敗:",e),e}};return a?(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-bg-primary",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-2 border-mingcare-blue border-t-transparent"}),(0,r.jsx)("p",{className:"text-apple-body text-text-secondary mt-4",children:"載入中..."})]})}):W?(0,r.jsxs)("div",{className:"min-h-screen bg-bg-primary overflow-auto",children:[(0,r.jsx)("header",{className:"card-apple border-b border-border-light fade-in-apple sticky top-0 z-10",children:(0,r.jsx)("div",{className:"px-6 lg:px-8",children:(0,r.jsxs)("div",{className:"flex justify-between items-center py-8",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-apple-title text-text-primary mb-2",children:"工資明細下載"}),(0,r.jsx)("p",{className:"text-apple-body text-text-secondary",children:"選擇護理員下載其工資明細"})]}),(0,r.jsx)("button",{onClick:()=>V(!1),className:"px-4 py-2 text-mingcare-blue border border-mingcare-blue rounded-lg hover:bg-mingcare-blue hover:text-white transition-all duration-200",children:"返回報表"})]})})}),(0,r.jsx)("main",{className:"px-6 lg:px-8 py-8 pb-16",children:(0,r.jsx)("div",{className:"card-apple",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-text-primary mb-6",children:"護理員工資明細"}),U?(0,r.jsx)("div",{className:"text-center py-12",children:(0,r.jsx)("p",{className:"text-text-secondary",children:"載入中..."})}):0===q.length?(0,r.jsx)("div",{className:"text-center py-12",children:(0,r.jsx)("p",{className:"text-text-secondary",children:"沒有找到護理員資料"})}):(0,r.jsx)("div",{className:"space-y-4 max-h-none",children:q.map(e=>{let t="downloaded"===A[e],a="downloading"===A[e],s="".concat(e," ").concat(y.dateRange.start.substring(0,7),"工資明細");return(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border border-border-light rounded-lg",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium text-text-primary",children:s}),(0,r.jsxs)("p",{className:"text-sm text-text-secondary mt-1",children:["期間：",y.dateRange.start," 至 ",y.dateRange.end]})]}),(0,r.jsx)("div",{className:"flex items-center space-x-3",children:t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"px-4 py-2 bg-green-100 text-green-700 border border-green-300 rounded-lg font-medium",children:"已成功下載"}),(0,r.jsx)("button",{onClick:async()=>{$(t=>({...t,[e]:"downloading"}));try{let t=await m(y,1,1e4);if(t.success&&t.data){let a=Object.entries(K).filter(e=>{let[t,a]=e;return a}).map(e=>{let[t,a]=e;return t});await er(e,t.data.data,a)}}catch(t){console.error("下載失敗:",t),$(t=>({...t,[e]:"error"})),alert("下載失敗，請重試")}},disabled:a,className:"px-4 py-2 bg-blue-100 text-blue-700 border border-blue-300 rounded-lg font-medium hover:bg-blue-200 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:"再次下載"})]}):(0,r.jsx)("button",{onClick:async()=>{if(!a){$(t=>({...t,[e]:"downloading"}));try{let t=await m(y,1,1e4);if(t.success&&t.data){let a=Object.entries(K).filter(e=>{let[t,a]=e;return a}).map(e=>{let[t,a]=e;return t});await er(e,t.data.data,a)}}catch(t){console.error("下載失敗:",t),$(t=>({...t,[e]:"error"})),alert("下載失敗，請重試")}}},disabled:a,className:"px-6 py-2 rounded-lg font-medium transition-all duration-200 ".concat(a?"bg-gray-100 text-gray-500 border border-gray-300 cursor-not-allowed":"bg-mingcare-blue text-white hover:bg-blue-600 active:bg-blue-700"),children:a?"下載中...":"下載"})})]},e)})})]})})})]}):(0,r.jsxs)("div",{className:"min-h-screen bg-bg-primary",children:[(0,r.jsx)("header",{className:"card-apple border-b border-border-light fade-in-apple sticky top-0 z-10",children:(0,r.jsx)("div",{className:"px-4 sm:px-6 lg:px-8",children:(0,r.jsxs)("div",{className:"flex justify-between items-center py-4 sm:py-6 lg:py-8",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("h1",{className:"text-lg sm:text-xl lg:text-2xl font-bold text-text-primary mb-1 truncate",children:"護理服務管理"}),(0,r.jsx)("p",{className:"text-xs sm:text-sm text-text-secondary hidden sm:block",children:"安排護理服務、管理服務排程及記錄"})]}),(0,r.jsx)("button",{onClick:()=>v.push("/dashboard"),className:"btn-apple-secondary text-xs px-3 py-2 ml-3 flex-shrink-0",children:"返回"})]})})}),(0,r.jsxs)("main",{className:"px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8",children:[(0,r.jsx)("div",{className:"mb-6",children:(0,r.jsx)("div",{className:"border-b border-border-light",children:(0,r.jsxs)("nav",{className:"-mb-px flex overflow-x-auto scrollbar-hide",children:[(0,r.jsx)("button",{onClick:()=>g("reports"),className:"py-3 px-2 sm:px-4 border-b-2 font-medium text-xs sm:text-sm transition-all duration-200 whitespace-nowrap flex-shrink-0 ".concat("reports"===u?"border-mingcare-blue text-mingcare-blue":"border-transparent text-text-secondary hover:text-text-primary hover:border-border-light"),children:(0,r.jsxs)("div",{className:"flex items-center space-x-1 sm:space-x-2",children:[(0,r.jsx)("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,r.jsx)("span",{children:"詳細報表"})]})}),(0,r.jsx)("button",{onClick:()=>g("schedule"),className:"py-3 px-2 sm:px-4 border-b-2 font-medium text-xs sm:text-sm transition-all duration-200 whitespace-nowrap flex-shrink-0 ".concat("schedule"===u?"border-mingcare-blue text-mingcare-blue":"border-transparent text-text-secondary hover:text-text-primary hover:border-border-light"),children:(0,r.jsxs)("div",{className:"flex items-center space-x-1 sm:space-x-2",children:[(0,r.jsx)("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),(0,r.jsx)("span",{children:"排程管理"})]})}),(0,r.jsx)("button",{onClick:()=>g("overview"),className:"py-3 px-2 sm:px-4 border-b-2 font-medium text-xs sm:text-sm transition-all duration-200 whitespace-nowrap flex-shrink-0 ".concat("overview"===u?"border-mingcare-blue text-mingcare-blue":"border-transparent text-text-secondary hover:text-text-primary hover:border-border-light"),children:(0,r.jsxs)("div",{className:"flex items-center space-x-1 sm:space-x-2",children:[(0,r.jsx)("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})}),(0,r.jsx)("span",{children:"業務概覽"})]})})]})})}),"overview"===u&&(0,r.jsx)(j,{filters:y,setFilters:w,updateDateRange:ee,kpiData:S,kpiLoading:o,categorySummary:D}),"schedule"===u&&(0,r.jsx)(_,{filters:y}),"reports"===u&&(0,r.jsx)(N,{filters:y,setFilters:w,updateDateRange:ee,exportLoading:d,handleExport:()=>{z(!0)},reportsViewMode:b,setReportsViewMode:f,onEdit:e=>{L(e),O(!0)}})]}),R&&F&&(0,r.jsx)(k,{isOpen:R,onClose:()=>{O(!1),L(null)},onSubmit:ec,onDelete:eo,existingRecord:F}),E&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col",children:[(0,r.jsx)("div",{className:"p-6 border-b border-gray-200 flex-shrink-0",children:(0,r.jsx)("h3",{className:"text-lg font-medium text-text-primary",children:"導出設定"})}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-6",children:[(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-3",children:"預設模式"}),(0,r.jsx)("div",{className:"space-y-3",children:Object.entries(X).map(e=>{let[t,a]=e;return(0,r.jsxs)("label",{className:"flex items-start",children:[(0,r.jsx)("input",{type:"radio",name:"exportMode",value:t,checked:P===t,onChange:e=>et(e.target.value),className:"mr-3 mt-1"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium text-text-primary",children:a.name}),(0,r.jsx)("div",{className:"text-sm text-text-secondary",children:a.description})]})]},t)})})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-3",children:"導出格式"}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"radio",name:"format",value:"pdf",checked:"pdf"===T,onChange:e=>I(e.target.value),className:"mr-2"}),(0,r.jsx)("span",{children:"PDF"})]}),(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"radio",name:"format",value:"csv",checked:"csv"===T,onChange:e=>I(e.target.value),className:"mr-2"}),(0,r.jsx)("span",{children:"CSV"})]})]})]}),"payroll"===P&&"pdf"===T&&(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-3",children:"工資導出方式"}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"radio",name:"payrollType",value:"combined",checked:"combined"===H,onChange:e=>Y(e.target.value),className:"mr-2"}),(0,r.jsx)("span",{children:"合併報表 (一個PDF包含所有人員)"})]}),(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"radio",name:"payrollType",value:"separate",checked:"separate"===H,onChange:e=>Y(e.target.value),className:"mr-2"}),(0,r.jsx)("span",{children:"個別報表 (每人單獨PDF檔案)"})]})]})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-text-primary mb-3",children:["選擇要導出的欄位",(0,r.jsxs)("span",{className:"text-xs text-text-secondary ml-2",children:["(",X[P].name," 預設配置，可自由調整)"]})]}),(0,r.jsx)("div",{className:"space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50",children:Object.entries({service_date:"服務日期",customer_id:"客戶編號",customer_name:"客戶姓名",phone:"客戶電話",service_address:"服務地址",start_time:"開始時間",end_time:"結束時間",service_hours:"服務時數",care_staff_name:"護理員姓名",service_fee:"服務費用",staff_salary:"護理員工資",hourly_rate:"每小時收費",hourly_salary:"每小時工資",service_type:"服務類型",project_category:"所屬項目",project_manager:"項目經理"}).map(e=>{let[t,a]=e,s=["service_date","customer_name","service_address","start_time","end_time","service_hours","care_staff_name","service_type"].includes(t);return(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"checkbox",checked:K[t],onChange:e=>{Z(a=>({...a,[t]:e.target.checked}))},className:"mr-2"}),(0,r.jsxs)("span",{className:"text-sm ".concat(s?"font-medium text-mingcare-blue":""),children:[a,s&&(0,r.jsx)("span",{className:"text-xs text-mingcare-blue ml-1",children:"(默認)"})]})]},t)})})]})]}),(0,r.jsxs)("div",{className:"p-6 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0",children:[(0,r.jsx)("button",{onClick:()=>z(!1),className:"px-4 py-2 text-text-secondary border border-border-light rounded-lg hover:bg-bg-secondary transition-all duration-200",children:"取消"}),(0,r.jsx)("button",{onClick:ea,disabled:Object.values(K).every(e=>!e),className:"px-4 py-2 bg-mingcare-blue text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:"確認導出"})]})]})})]})}function k(e){let{isOpen:t,onClose:a,selectedDate:n,selectedDates:l=[],onSubmit:c,onDelete:m,isMultiDay:x=!1,existingRecord:u=null}=e,p=()=>u?{service_date:u.service_date,customer_id:u.customer_id,customer_name:u.customer_name,phone:u.phone,service_address:u.service_address,start_time:u.start_time,end_time:u.end_time,service_hours:u.service_hours,care_staff_name:u.care_staff_name,service_fee:u.service_fee,staff_salary:u.staff_salary,hourly_rate:u.hourly_rate||0,hourly_salary:u.hourly_salary||0,service_type:u.service_type,project_category:u.project_category,project_manager:u.project_manager}:{service_date:n||f(new Date),customer_id:"",customer_name:"",phone:"",service_address:"",start_time:"09:00",end_time:"17:00",service_hours:8,care_staff_name:"",service_fee:0,staff_salary:0,hourly_rate:0,hourly_salary:0,service_type:"",project_category:"",project_manager:""},[h,g]=(0,s.useState)(p);(0,s.useEffect)(()=>{g(p()),u?(N(u.customer_name),M(u.care_staff_name)):(N(""),M(""))},[u,n]);let[b,v]=(0,s.useState)(!1),[y,j]=(0,s.useState)({}),[_,N]=(0,s.useState)(u?u.customer_name:""),[w,k]=(0,s.useState)([]),[S,C]=(0,s.useState)(!1),[D,M]=(0,s.useState)(u?u.care_staff_name:""),[F,L]=(0,s.useState)([]),[R,O]=(0,s.useState)(!1),E=x||l.length>1,z=e=>{let t={};return e.customer_name.trim()||(t.customer_name="客戶姓名不能為空"),e.phone.trim()||(t.phone="聯絡電話不能為空"),e.service_address.trim()||(t.service_address="服務地址不能為空"),e.care_staff_name.trim()||(t.care_staff_name="護理人員不能為空"),e.service_fee<=0&&(t.service_fee="服務費用必須大於 0"),e.staff_salary<0&&(t.staff_salary="員工薪資不能為負數"),e.service_hours<=0&&(t.service_hours="服務時數必須大於 0"),e.service_type||(t.service_type="請選擇服務類型"),e.project_category||(t.project_category="請選擇項目分類"),e.project_manager||(t.project_manager="請選擇項目負責人"),e.start_time>=e.end_time&&(t.end_time="結束時間必須晚於開始時間"),t},T=(e,t)=>{let[a,r]=e.split(":").map(Number),[s,n]=t.split(":").map(Number);return Math.max(0,(60*s+n-(60*a+r))/60)},I=async e=>{e.preventDefault(),v(!0);try{let e=z(h);if(Object.keys(e).length>0){j(e);return}j({});let t={service_date:h.service_date,customer_id:h.customer_id,customer_name:h.customer_name,phone:h.phone,service_address:h.service_address,start_time:h.start_time,end_time:h.end_time,service_hours:h.service_hours,care_staff_name:h.care_staff_name,service_fee:h.service_fee,staff_salary:h.staff_salary,service_type:h.service_type,project_category:h.project_category,project_manager:h.project_manager};await c(t),a()}catch(e){console.error("提交表單失敗:",e)}finally{v(!1)}},P=(e,t)=>{g(a=>{let r={...a,[e]:t};if("service_date"===e&&t&&"string"==typeof t&&t.match(/^\d{4}-\d{2}-\d{2}$/)&&(r.service_date=t),("start_time"===e||"end_time"===e)&&r.start_time&&r.end_time){let e=T(r.start_time,r.end_time);r.service_hours=Math.round(2*e)/2}return("service_fee"===e||"staff_salary"===e||"service_hours"===e)&&r.service_hours>0&&(r.hourly_rate=(r.service_fee||0)/r.service_hours,r.hourly_salary=(r.staff_salary||0)/r.service_hours),r}),"customer_name"===e?N(t):"care_staff_name"===e&&M(t)},B=async e=>{if(N(e),e.trim().length<1){k([]),C(!1);return}try{let t=await fetch("/api/search-customers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchTerm:e})});if(t.ok){let e=await t.json();k(e.data||[]),C(!0)}}catch(e){console.error("客戶搜尋失敗:",e)}},H=e=>{P("customer_name",e.customer_name),P("customer_id",e.customer_id||""),P("phone",e.phone||""),P("service_address",e.service_address||""),N(e.customer_name),C(!1)},Y=async e=>{if(M(e),e.trim().length<1){L([]),O(!1);return}try{let t=await fetch("/api/search-care-staff",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({searchTerm:e})});if(t.ok){let e=await t.json();L(e.data||[]),O(!0)}}catch(e){console.error("護理人員搜尋失敗:",e)}},W=e=>{P("care_staff_name",e.name_chinese),M(e.name_chinese),O(!1)};return t?(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-bg-primary rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden",children:[(0,r.jsxs)("div",{className:"p-6 border-b border-border-light",children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-text-primary",children:u?"編輯排班 - ".concat(u.service_date):E?"批量新增排班 (".concat(l.length," 天)"):"新增排班 - ".concat(n)}),E&&(0,r.jsxs)("div",{className:"mt-2 text-sm text-text-secondary",children:["選定日期：",l.sort().join(", ")]})]}),(0,r.jsx)("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-200px)]",children:(0,r.jsxs)("form",{onSubmit:I,className:"space-y-6",children:[u&&(0,r.jsx)("div",{className:"card-apple border border-border-light",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h4",{className:"text-apple-heading text-text-primary mb-4",children:"服務日期"}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["日期 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsx)("input",{type:"date",value:h.service_date,onChange:e=>P("service_date",e.target.value),className:"form-input-apple w-full ".concat(y.service_date?"border-danger":""),required:!0}),y.service_date&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.service_date})]})]})}),(0,r.jsx)("div",{className:"card-apple border border-border-light",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h4",{className:"text-apple-heading text-text-primary mb-4",children:"客戶基本資料"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["服務類型 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsxs)("select",{value:h.service_type,onChange:e=>P("service_type",e.target.value),className:"form-input-apple w-full ".concat(y.service_type?"border-danger":""),required:!0,children:[(0,r.jsx)("option",{value:"",children:"請選擇服務類型"}),o.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))]}),y.service_type&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.service_type})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["項目分類 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsxs)("select",{value:h.project_category,onChange:e=>P("project_category",e.target.value),className:"form-input-apple w-full ".concat(y.project_category?"border-danger":""),required:!0,children:[(0,r.jsx)("option",{value:"",children:"請選擇項目分類"}),i.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))]}),y.project_category&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.project_category})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["項目負責人 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsxs)("select",{value:h.project_manager,onChange:e=>P("project_manager",e.target.value),className:"form-input-apple w-full ".concat(y.project_manager?"border-danger":""),required:!0,children:[(0,r.jsx)("option",{value:"",children:"請選擇項目負責人"}),d.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))]}),y.project_manager&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.project_manager})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["客戶姓名 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsx)("input",{type:"text",value:_,onChange:e=>{let t=e.target.value;N(t),P("customer_name",t),t.length>=1?B(t):C(!1)},className:"form-input-apple w-full ".concat(y.customer_name?"border-danger":""),placeholder:"請輸入客戶姓名或編號（≥1字元）",autoComplete:"off",required:!0}),S&&w.length>0&&(0,r.jsx)("div",{className:"absolute z-10 w-full mt-1 bg-bg-primary border border-border-light rounded-lg shadow-lg max-h-48 overflow-y-auto",children:w.map((e,t)=>(0,r.jsxs)("div",{onClick:()=>H(e),className:"px-4 py-2 hover:bg-bg-secondary cursor-pointer border-b border-border-light last:border-b-0",children:[(0,r.jsxs)("div",{className:"font-medium text-text-primary",children:[e.customer_name,e.customer_id&&(0,r.jsxs)("span",{className:"text-text-secondary ml-1",children:["（",e.customer_id,"）"]})]}),e.phone&&(0,r.jsx)("div",{className:"text-sm text-text-secondary",children:e.phone}),e.service_address&&(0,r.jsx)("div",{className:"text-sm text-text-secondary truncate",children:e.service_address})]},e.customer_id||t))}),y.customer_name&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.customer_name})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"客戶編號"}),(0,r.jsx)("input",{type:"text",value:h.customer_id||"",readOnly:!0,className:"form-input-apple w-full bg-bg-secondary text-text-secondary cursor-not-allowed",placeholder:"選擇客戶後自動填入"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"聯絡電話"}),(0,r.jsx)("input",{type:"tel",value:h.phone,readOnly:!0,className:"form-input-apple w-full bg-bg-secondary text-text-secondary cursor-not-allowed",placeholder:"選擇客戶後自動填入"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"服務地址"}),(0,r.jsx)("input",{type:"text",value:h.service_address,onChange:e=>P("service_address",e.target.value),className:"form-input-apple w-full ".concat(y.service_address?"border-danger":""),placeholder:"請輸入服務地址"}),y.service_address&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.service_address})]})]})]})]})}),(0,r.jsx)("div",{className:"card-apple border border-border-light",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h4",{className:"text-apple-heading text-text-primary mb-4",children:"服務詳情"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"護理人員"}),(0,r.jsx)("input",{type:"text",value:D,onChange:e=>{let t=e.target.value;M(t),P("care_staff_name",t),t.length>=1?Y(t):O(!1)},className:"form-input-apple w-full ".concat(y.care_staff_name?"border-danger":""),placeholder:"輸入護理人員中文姓名或編號（≥1字元）",autoComplete:"off"}),R&&F.length>0&&(0,r.jsx)("div",{className:"absolute z-10 w-full mt-1 bg-bg-primary border border-border-light rounded-lg shadow-lg max-h-48 overflow-y-auto",children:F.map((e,t)=>(0,r.jsx)("div",{onClick:()=>W(e),className:"px-4 py-2 hover:bg-bg-secondary cursor-pointer border-b border-border-light last:border-b-0",children:(0,r.jsxs)("div",{className:"font-medium text-text-primary",children:[e.name_chinese,e.staff_id&&(0,r.jsxs)("span",{className:"text-text-secondary ml-1",children:["（",e.staff_id,"）"]})]})},e.staff_id||t))}),y.care_staff_name&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.care_staff_name})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"開始時間"}),(0,r.jsx)("input",{type:"time",value:h.start_time,onChange:e=>P("start_time",e.target.value),className:"form-input-apple w-full",step:"1800"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"結束時間"}),(0,r.jsx)("input",{type:"time",value:h.end_time,onChange:e=>P("end_time",e.target.value),className:"form-input-apple w-full ".concat(y.end_time?"border-danger":""),step:"1800"}),y.end_time&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.end_time})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["服務時數 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsx)("input",{type:"number",value:h.service_hours||"",onChange:e=>P("service_hours",parseFloat(e.target.value)||0),className:"form-input-apple w-full ".concat(y.service_hours?"border-danger":""),placeholder:"請輸入服務時數",step:"0.5",min:"0",required:!0}),y.service_hours&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.service_hours}),(0,r.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"填入開始/結束時間後會自動計算，也可手動輸入"})]})]})]})}),(0,r.jsx)("div",{className:"card-apple border border-border-light",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("h4",{className:"text-apple-heading text-text-primary mb-4",children:"收費與工資"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["服務費用 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsx)("input",{type:"number",value:h.service_fee||"",onChange:e=>P("service_fee",parseFloat(e.target.value)||0),className:"form-input-apple w-full ".concat(y.service_fee?"border-danger":""),placeholder:"請輸入服務費用",min:"0",step:"0.01",required:!0}),y.service_fee&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.service_fee})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["員工薪資 ",(0,r.jsx)("span",{className:"text-danger",children:"*"})]}),(0,r.jsx)("input",{type:"number",value:h.staff_salary||"",onChange:e=>P("staff_salary",parseFloat(e.target.value)||0),className:"form-input-apple w-full ".concat(y.staff_salary?"border-danger":""),placeholder:"請輸入員工薪資",min:"0",max:h.service_fee||void 0,step:"0.01",required:!0}),y.staff_salary&&(0,r.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:y.staff_salary}),(0,r.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"員工薪資不能超過服務費用"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"每小時收費"}),(0,r.jsx)("input",{type:"number",value:h.hourly_rate.toFixed(2),readOnly:!0,className:"form-input-apple w-full bg-bg-secondary text-text-secondary cursor-not-allowed",placeholder:"自動計算"}),(0,r.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"自動計算：服務費用 \xf7 服務時數"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:"每小時薪資"}),(0,r.jsx)("input",{type:"number",value:h.hourly_salary.toFixed(2),readOnly:!0,className:"form-input-apple w-full bg-bg-secondary text-text-secondary cursor-not-allowed",placeholder:"自動計算"}),(0,r.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"自動計算：員工薪資 \xf7 服務時數"})]})]}),(0,r.jsxs)("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("label",{className:"text-apple-body font-medium text-green-800",children:"本次利潤"}),(0,r.jsxs)("div",{className:"text-apple-heading font-bold text-green-700",children:["$",((h.service_fee||0)-(h.staff_salary||0)).toFixed(2)]})]}),(0,r.jsx)("p",{className:"text-apple-caption text-green-600 mt-1",children:"計算公式：服務費用 - 員工薪資"})]}),(0,r.jsxs)("div",{className:"border-t border-border-light pt-4",children:[(0,r.jsx)("h5",{className:"text-apple-body font-medium text-text-primary mb-2",children:"費用摘要"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-text-secondary",children:"服務費用"}),(0,r.jsxs)("div",{className:"font-medium text-text-primary",children:["$",(h.service_fee||0).toFixed(2)]})]}),(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-text-secondary",children:"員工薪資"}),(0,r.jsxs)("div",{className:"font-medium text-text-primary",children:["$",(h.staff_salary||0).toFixed(2)]})]}),(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-text-secondary",children:"利潤率"}),(0,r.jsx)("div",{className:"font-medium text-text-primary",children:(h.service_fee||0)>0?"".concat((((h.service_fee||0)-(h.staff_salary||0))/(h.service_fee||1)*100).toFixed(1),"%"):"0%"})]}),(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-text-secondary",children:"服務時數"}),(0,r.jsxs)("div",{className:"font-medium text-text-primary",children:[h.service_hours,"小時"]})]})]})]})]})]})})]})}),(0,r.jsx)("div",{className:"p-6 border-t border-border-light bg-bg-secondary",children:(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("div",{children:u&&m&&(0,r.jsx)("button",{type:"button",onClick:async()=>{if(confirm("確定要刪除這筆記錄嗎？此操作無法復原。"))try{await m(u.id),a()}catch(e){console.error("刪除失敗:",e),alert("刪除失敗，請稍後再試")}},disabled:b,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 disabled:opacity-50",children:b?"刪除中...":"刪除"})}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("button",{type:"button",onClick:a,className:"px-4 py-2 text-text-secondary border border-border-light rounded-lg hover:bg-bg-primary transition-all duration-200",disabled:b,children:"取消"}),(0,r.jsx)("button",{type:"submit",onClick:I,disabled:b,className:"px-4 py-2 bg-mingcare-blue text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 disabled:opacity-50",children:b?"處理中...":u?"儲存修改":E?"批量新增":"新增排班"})]})]})})]})}):null}function S(e){let{isOpen:t,schedule:a,onClose:s,onUpdate:n,onDelete:l,onEdit:c}=e;return t&&a?(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-bg-primary rounded-lg w-full max-w-md max-h-[90vh] overflow-hidden",children:[(0,r.jsxs)("div",{className:"p-6 border-b border-border-light",children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-text-primary",children:"排程選項"}),(0,r.jsx)("p",{className:"text-sm text-text-secondary mt-1",children:"選擇要對此排程執行的操作"})]}),(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6",children:[(0,r.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:[(0,r.jsx)("strong",{children:"日期："})," ",a.service_date]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:[(0,r.jsx)("strong",{children:"客戶："})," ",a.customer_name]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:[(0,r.jsx)("strong",{children:"護理人員："})," ",a.care_staff_name]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:[(0,r.jsx)("strong",{children:"服務類型："})," ",a.service_type]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,r.jsx)("strong",{children:"時間："})," ",a.start_time," - ",a.end_time]})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("button",{onClick:c,className:"w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-left",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("svg",{className:"w-5 h-5 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"編輯排程"]})}),(0,r.jsx)("button",{onClick:()=>{confirm("確定要刪除這個排程嗎？")&&l()},className:"w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-left",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("svg",{className:"w-5 h-5 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"刪除排程"]})})]})]}),(0,r.jsx)("div",{className:"p-6 border-t border-border-light bg-bg-secondary",children:(0,r.jsx)("button",{onClick:s,className:"w-full px-4 py-2 text-text-secondary border border-border-light rounded-lg hover:bg-bg-primary transition-all duration-200",children:"取消"})})]})}):null}},2141:function(e,t,a){"use strict";a.d(t,{O:function(){return r}});let r=(0,a(3960).AY)("https://cvkxlvdicympakfecgvv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3hsdmRpY3ltcGFrZmVjZ3Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MjkxODEsImV4cCI6MjA2NzAwNTE4MX0.jp2fPKcBcG4-042UoN3OieR553WAgABhJIujiDJAt-I")}},function(e){e.O(0,[998,971,117,744],function(){return e(e.s=6615)}),_N_E=e.O()}]);