(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[897],{5753:function(e,t,a){Promise.resolve().then(a.bind(a,2089))},2089:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return n}});var s=a(7437),r=a(2265),l=a(9376),i=a(2141),o=a(8478);function n(){let[e,t]=(0,r.useState)(null),[a,n]=(0,r.useState)(!0),[c,d]=(0,r.useState)(!1),[u,p]=(0,r.useState)(""),[m,h]=(0,r.useState)("initial"),[x,v]=(0,r.useState)({customer_type:"社區券客戶",customer_name:"",service_address:"",charity_support:!1}),[_,j]=(0,r.useState)({}),g=(0,l.useRouter)();(0,r.useEffect)(()=>{(async()=>{let{data:{user:e}}=await i.O.auth.getUser();e?t(e):g.push("/"),n(!1)})()},[g]);let y=async()=>{try{if(!("明家街客"===x.customer_type||"社區券客戶"===x.customer_type&&"已經持有"===x.voucher_application_status)){p("");return}let e=await o.n.generateNextCustomerId(x.customer_type,x.introducer);p(e),j(e=>({...e,general:""}))}catch(e){console.error("生成客戶編號失敗:",e),j(t=>({...t,general:e.message||"生成客戶編號失敗，請稍後再試"}))}};(0,r.useEffect)(()=>{x.customer_type&&x.introducer&&y()},[x.customer_type,x.introducer,x.voucher_application_status]),(0,r.useEffect)(()=>{if(x.customer_type&&x.introducer&&"initial"===m){let e=setTimeout(()=>{h("expanded")},500);return()=>clearTimeout(e)}},[x.customer_type,x.introducer,m]);let b=e=>{if(!e)return;let t=new Date(e),a=new Date,s=a.getFullYear()-t.getFullYear(),r=a.getMonth()-t.getMonth();return(r<0||0===r&&a.getDate()<t.getDate())&&s--,s>=0?s:void 0},f=(e,t)=>{v(a=>{let s={...a,[e]:t};return"dob"===e&&(s.age=b(t)),"customer_type"===e&&("明家街客"===t?(s.voucher_application_status=void 0,s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0,s.home_visit_status=void 0):"社區券客戶"===t&&(s.voucher_application_status=void 0,s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0,s.home_visit_status=void 0)),"voucher_application_status"===e&&("已經持有"===t?s.lds_status="已經持有":"申請中"===t?(s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0):(s.voucher_number="",s.copay_level=void 0,s.charity_support=void 0,s.lds_status=void 0,s.home_visit_status=void 0)),"copay_level"===e&&"5%"!==t&&(s.charity_support=void 0),s}),_[e]&&j(t=>{let a={...t};return delete a[e],a})},N=()=>{var e,t,a;let s={};return(null===(e=x.customer_name)||void 0===e?void 0:e.trim())||(s.customer_name="請輸入客戶姓名"),(null===(t=x.service_address)||void 0===t?void 0:t.trim())||(s.service_address="請輸入服務地址"),"社區券客戶"!==x.customer_type||(x.voucher_application_status||(s.voucher_application_status="請選擇社區券申請狀況"),"已經持有"===x.voucher_application_status&&((null===(a=x.voucher_number)||void 0===a?void 0:a.trim())||(s.voucher_number="請輸入社區券號碼"),x.copay_level||(s.copay_level="請選擇自付比例等級"),"5%"===x.copay_level&&void 0===x.charity_support&&(s.charity_support="請選擇是否需要慈善機構贊助")),"申請中"!==x.voucher_application_status&&"已經持有"!==x.voucher_application_status||(x.lds_status||(s.lds_status="請選擇LDS狀況"),x.home_visit_status||(s.home_visit_status="請選擇家訪狀況"))),j(s),0===Object.keys(s).length},k=async e=>{if(e.preventDefault(),N()){d(!0);try{let e;if(x.dob){let t=new Date(x.dob),a=new Date;e=a.getFullYear()-t.getFullYear();let s=a.getMonth()-t.getMonth();(s<0||0===s&&a.getDate()<t.getDate())&&e--}let t={customer_type:x.customer_type,customer_name:x.customer_name,service_address:x.service_address,phone:x.phone||void 0,hkid:x.hkid||void 0,dob:x.dob||void 0,age:e||void 0,district:x.district||void 0,health_status:x.health_status||void 0,introducer:x.introducer||void 0,staff_owner:x.staff_owner||void 0,charity_support:!1};"社區券客戶"===x.customer_type&&x.voucher_application_status&&(t.voucher_application_status=x.voucher_application_status,x.lds_status&&(t.lds_status=x.lds_status),x.home_visit_status&&(t.home_visit_status=x.home_visit_status),"已經持有"===x.voucher_application_status&&(x.voucher_number&&(t.voucher_number=x.voucher_number),x.copay_level&&(t.copay_level=x.copay_level),"5%"===x.copay_level&&void 0!==x.charity_support&&(t.charity_support=x.charity_support)));let a=await o.n.createCustomer(t);a.success?g.push("/clients"):j({general:a.error||"新增客戶失敗"})}catch(e){console.error("新增客戶失敗:",e),j({general:e.message||"新增客戶失敗，請稍後再試"})}finally{d(!1)}}};return a?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-bg-primary",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-2 border-mingcare-blue border-t-transparent"}),(0,s.jsx)("p",{className:"text-apple-body text-text-secondary mt-4",children:"載入中..."})]})}):(0,s.jsxs)("div",{className:"min-h-screen bg-bg-primary",children:[(0,s.jsx)("header",{className:"card-apple border-b border-border-light fade-in-apple",children:(0,s.jsx)("div",{className:"max-w-4xl mx-auto px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"flex justify-between items-center py-8",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-apple-title text-text-primary mb-2",children:"新增客戶"}),(0,s.jsx)("p",{className:"text-apple-body text-text-secondary",children:"建立新的客戶資料"})]}),(0,s.jsxs)("button",{onClick:()=>g.push("/clients"),className:"btn-apple-secondary",children:[(0,s.jsx)("svg",{className:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"返回客戶列表"]})]})})}),(0,s.jsx)("main",{className:"max-w-4xl mx-auto py-8 px-6 lg:px-8",children:(0,s.jsxs)("form",{onSubmit:k,className:"space-y-8",children:[_.general&&(0,s.jsx)("div",{className:"card-apple border-danger bg-danger-light fade-in-apple",children:(0,s.jsx)("div",{className:"card-apple-content",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("svg",{className:"h-5 w-5 text-danger mr-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,s.jsx)("p",{className:"text-apple-body text-danger",children:_.general})]})})}),(0,s.jsx)("div",{className:"card-apple fade-in-apple",children:(0,s.jsxs)("div",{className:"card-apple-content",children:[(0,s.jsx)("h2",{className:"text-apple-heading text-text-primary mb-6",children:"基礎資訊"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["客戶類型 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:x.customer_type,onChange:e=>f("customer_type",e.target.value),className:"form-input-apple",required:!0,children:[(0,s.jsx)("option",{value:"社區券客戶",children:"社區券客戶"}),(0,s.jsx)("option",{value:"明家街客",children:"明家街客"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["介紹人 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:x.introducer||"",onChange:e=>f("introducer",e.target.value),className:"form-input-apple",required:!0,children:[(0,s.jsx)("option",{value:"",children:"請選擇介紹人"}),(0,s.jsx)("option",{value:"Kanas Leung",children:"Kanas Leung"}),(0,s.jsx)("option",{value:"Joe Cheung",children:"Joe Cheung"}),(0,s.jsx)("option",{value:"Candy Ho",children:"Candy Ho"}),(0,s.jsx)("option",{value:"Steven Kwok",children:"Steven Kwok"}),(0,s.jsx)("option",{value:"Dr.Lee",children:"Dr.Lee"}),(0,s.jsx)("option",{value:"Annie",children:"Annie"}),(0,s.jsx)("option",{value:"Janet",children:"Janet"}),(0,s.jsx)("option",{value:"陸sir",children:"陸sir"}),(0,s.jsx)("option",{value:"吳翹政",children:"吳翹政"}),(0,s.jsx)("option",{value:"余翠英",children:"余翠英"}),(0,s.jsx)("option",{value:"陳小姐MC01",children:"陳小姐MC01"}),(0,s.jsx)("option",{value:"曾先生",children:"曾先生"})]})]})]}),"社區券客戶"===x.customer_type&&(0,s.jsxs)("div",{className:"mt-6 pt-6 border-t border-border-primary",children:[(0,s.jsx)("h3",{className:"text-apple-body font-semibold text-text-primary mb-4",children:"社區券資訊"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["申請狀況 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:x.voucher_application_status||"",onChange:e=>f("voucher_application_status",e.target.value),className:"form-input-apple ".concat(_.voucher_application_status?"border-danger":""),required:!0,children:[(0,s.jsx)("option",{value:"",children:"請選擇申請狀況"}),(0,s.jsx)("option",{value:"已經持有",children:"已經持有"}),(0,s.jsx)("option",{value:"申請中",children:"申請中"})]}),_.voucher_application_status&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:_.voucher_application_status})]}),("申請中"===x.voucher_application_status||"已經持有"===x.voucher_application_status)&&(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["LDS 狀態 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:x.lds_status||"",onChange:e=>f("lds_status",e.target.value),className:"form-input-apple ".concat(_.lds_status?"border-danger":""),disabled:"已經持有"===x.voucher_application_status,required:!0,children:[(0,s.jsx)("option",{value:"",children:"請選擇 LDS 狀態"}),(0,s.jsx)("option",{value:"已完成評估",children:"已完成評估"}),(0,s.jsx)("option",{value:"已經持有",children:"已經持有"}),(0,s.jsx)("option",{value:"待社工評估",children:"待社工評估"})]}),"已經持有"===x.voucher_application_status&&(0,s.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"已自動設為「已經持有」"}),_.lds_status&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:_.lds_status})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["家訪狀況 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:x.home_visit_status||"",onChange:e=>f("home_visit_status",e.target.value),className:"form-input-apple ".concat(_.home_visit_status?"border-danger":""),required:!0,children:[(0,s.jsx)("option",{value:"",children:"請選擇家訪狀況"}),(0,s.jsx)("option",{value:"已完成",children:"已完成"}),(0,s.jsx)("option",{value:"未完成",children:"未完成"})]}),_.home_visit_status&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:_.home_visit_status})]})]}),"已經持有"===x.voucher_application_status&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["社區券號碼 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsx)("input",{type:"text",value:x.voucher_number||"",onChange:e=>f("voucher_number",e.target.value),className:"form-input-apple ".concat(_.voucher_number?"border-danger":""),placeholder:"請輸入社區券號碼",required:!0}),_.voucher_number&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:_.voucher_number})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["自付額 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("select",{value:x.copay_level||"",onChange:e=>f("copay_level",e.target.value),className:"form-input-apple ".concat(_.copay_level?"border-danger":""),required:!0,children:[(0,s.jsx)("option",{value:"",children:"請選擇自付額"}),(0,s.jsx)("option",{value:"5%",children:"5%"}),(0,s.jsx)("option",{value:"8%",children:"8%"}),(0,s.jsx)("option",{value:"12%",children:"12%"}),(0,s.jsx)("option",{value:"16%",children:"16%"}),(0,s.jsx)("option",{value:"25%",children:"25%"}),(0,s.jsx)("option",{value:"40%",children:"40%"})]}),_.copay_level&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:_.copay_level})]})]}),"5%"===x.copay_level&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-caption font-medium text-text-primary mb-2",children:["慈善補助 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsxs)("div",{className:"flex space-x-4 mt-2",children:[(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"radio",name:"charity_support",value:"true",checked:!0===x.charity_support,onChange:e=>f("charity_support","true"===e.target.value),className:"w-4 h-4 text-mingcare-blue focus:ring-mingcare-blue"}),(0,s.jsx)("span",{className:"ml-2 text-apple-caption",children:"是"})]}),(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"radio",name:"charity_support",value:"false",checked:!1===x.charity_support,onChange:e=>f("charity_support","false"===e.target.value),className:"w-4 h-4 text-mingcare-blue focus:ring-mingcare-blue"}),(0,s.jsx)("span",{className:"ml-2 text-apple-caption",children:"否"})]})]}),_.charity_support&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-1",children:_.charity_support})]})]})]})]}),x.customer_type&&x.introducer&&(0,s.jsx)("div",{className:"mt-6 bg-bg-tertiary rounded-apple-sm p-4 fade-in-apple",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-mingcare-blue rounded-full flex items-center justify-center mr-4",children:(0,s.jsx)("svg",{className:"h-6 w-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"})})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-apple-caption text-text-secondary",children:"客戶編號"}),(0,s.jsx)("p",{className:"text-apple-heading text-text-primary font-mono",children:u||("社區券客戶"===x.customer_type&&"申請中"===x.voucher_application_status?"申請中不生成編號":"生成中...")}),"社區券客戶"===x.customer_type&&"申請中"===x.voucher_application_status&&(0,s.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"客戶編號將在申請狀況變更為「已經持有」後生成"})]})]})})]})}),(0,s.jsx)("div",{className:"overflow-hidden transition-all duration-700 ease-in-out ".concat("expanded"===m?"max-h-screen opacity-100 transform translate-y-0":"max-h-0 opacity-0 transform -translate-y-4"),children:(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsx)("div",{className:"card-apple",children:(0,s.jsxs)("div",{className:"card-apple-content",children:[(0,s.jsx)("h2",{className:"text-apple-heading text-text-primary mb-6",children:"基本資料"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["客戶姓名 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsx)("input",{type:"text",value:x.customer_name,onChange:e=>f("customer_name",e.target.value),className:"form-input-apple ".concat(_.customer_name?"border-danger":""),placeholder:"請輸入客戶姓名",required:!0}),_.customer_name&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-2",children:_.customer_name})]}),(0,s.jsxs)("div",{className:"md:col-span-2",children:[(0,s.jsxs)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:["服務地址 ",(0,s.jsx)("span",{className:"text-danger",children:"*"})]}),(0,s.jsx)("input",{type:"text",value:x.service_address,onChange:e=>f("service_address",e.target.value),className:"form-input-apple ".concat(_.service_address?"border-danger":""),placeholder:"請輸入服務地址",required:!0}),_.service_address&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-2",children:_.service_address})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"電話號碼"}),(0,s.jsx)("input",{type:"tel",value:x.phone||"",onChange:e=>f("phone",e.target.value),className:"form-input-apple ".concat(_.phone?"border-danger":""),placeholder:"請輸入電話號碼"}),_.phone&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-2",children:_.phone})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"身份證號碼"}),(0,s.jsx)("input",{type:"text",value:x.hkid||"",onChange:e=>f("hkid",e.target.value.toUpperCase()),className:"form-input-apple ".concat(_.hkid?"border-danger":""),placeholder:"例: A123456(7)"}),_.hkid&&(0,s.jsx)("p",{className:"text-apple-caption text-danger mt-2",children:_.hkid})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"出生日期"}),(0,s.jsx)("input",{type:"date",value:x.dob||"",onChange:e=>f("dob",e.target.value),className:"form-input-apple"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"年齡"}),(0,s.jsx)("input",{type:"text",value:x.age?"".concat(x.age," 歲"):"",readOnly:!0,disabled:!0,className:"form-input-apple bg-bg-secondary text-text-secondary",placeholder:"自動計算"}),(0,s.jsx)("p",{className:"text-apple-caption text-text-secondary mt-1",children:"年齡將根據出生日期自動計算"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"客戶地區"}),(0,s.jsxs)("select",{value:x.district||"",onChange:e=>f("district",e.target.value),className:"form-input-apple",children:[(0,s.jsx)("option",{value:"",children:"請選擇地區"}),(0,s.jsx)("option",{value:"中西區",children:"中西區"}),(0,s.jsx)("option",{value:"九龍城區",children:"九龍城區"}),(0,s.jsx)("option",{value:"元朗區",children:"元朗區"}),(0,s.jsx)("option",{value:"北區",children:"北區"}),(0,s.jsx)("option",{value:"南區",children:"南區"}),(0,s.jsx)("option",{value:"大埔區",children:"大埔區"}),(0,s.jsx)("option",{value:"屯門區",children:"屯門區"}),(0,s.jsx)("option",{value:"東區",children:"東區"}),(0,s.jsx)("option",{value:"沙田區",children:"沙田區"}),(0,s.jsx)("option",{value:"油尖旺區",children:"油尖旺區"}),(0,s.jsx)("option",{value:"深水埗區",children:"深水埗區"}),(0,s.jsx)("option",{value:"灣仔區",children:"灣仔區"}),(0,s.jsx)("option",{value:"荃灣區",children:"荃灣區"}),(0,s.jsx)("option",{value:"葵青區",children:"葵青區"}),(0,s.jsx)("option",{value:"西貢區",children:"西貢區"}),(0,s.jsx)("option",{value:"觀塘區",children:"觀塘區"}),(0,s.jsx)("option",{value:"離島區",children:"離島區"}),(0,s.jsx)("option",{value:"黃大仙區",children:"黃大仙區"}),(0,s.jsx)("option",{value:"未分類（醫院,院舍)",children:"未分類（醫院,院舍)"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"項目經理"}),(0,s.jsxs)("select",{value:x.staff_owner||"",onChange:e=>f("staff_owner",e.target.value),className:"form-input-apple",children:[(0,s.jsx)("option",{value:"",children:"請選擇項目經理"}),(0,s.jsx)("option",{value:"Kanas Leung",children:"Kanas Leung"}),(0,s.jsx)("option",{value:"Joe Cheung",children:"Joe Cheung"}),(0,s.jsx)("option",{value:"Candy Ho",children:"Candy Ho"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-apple-body font-medium text-text-primary mb-2",children:"身體狀況"}),(0,s.jsxs)("select",{value:x.health_status||"",onChange:e=>f("health_status",e.target.value),className:"form-input-apple",children:[(0,s.jsx)("option",{value:"",children:"請選擇身體狀況"}),(0,s.jsx)("option",{value:"良好",children:"良好"}),(0,s.jsx)("option",{value:"中風",children:"中風"}),(0,s.jsx)("option",{value:"需協助",children:"需協助"}),(0,s.jsx)("option",{value:"長期病患",children:"長期病患"}),(0,s.jsx)("option",{value:"認知障礙",children:"認知障礙"})]})]})]})]})}),(0,s.jsxs)("div",{className:"flex justify-end space-x-4",children:[(0,s.jsx)("button",{type:"button",onClick:()=>g.push("/clients"),className:"btn-apple-secondary",children:"取消"}),(0,s.jsx)("button",{type:"submit",disabled:c,className:"btn-apple-primary disabled:opacity-50 disabled:cursor-not-allowed",children:c?"新增中...":"新增客戶"})]})]})})]})})]})}},2141:function(e,t,a){"use strict";a.d(t,{O:function(){return s}});let s=(0,a(3960).AY)("https://cvkxlvdicympakfecgvv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3hsdmRpY3ltcGFrZmVjZ3Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MjkxODEsImV4cCI6MjA2NzAwNTE4MX0.jp2fPKcBcG4-042UoN3OieR553WAgABhJIujiDJAt-I")},8478:function(e,t,a){"use strict";a.d(t,{n:function(){return r}});var s=a(2141);class r{static isUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)}static async queryBySmartId(e,t){let a=this.isUUID(e),r=a?"id":"customer_id";return console.log("Using ".concat(r," query for ").concat(a?"UUID":"customer number",":"),e),t(s.O.from("customer_personal_data"),r)}static async generateNextCustomerId(e,t){try{let{data:a,error:r}=await s.O.rpc("generate_next_customer_id",{p_customer_type:e,p_introducer:t||null});if(r)throw console.error("RPC 錯誤:",r),Error("生成客戶編號失敗: ".concat(r.message));if(!a)throw Error("RPC 未返回編號");return a}catch(e){throw console.error("生成客戶編號失敗:",e),Error("生成客戶編號失敗: ".concat(e.message||"未知錯誤"))}}static async getSearchSuggestions(e){try{if(e.query.length<2)return{data:[],error:"請輸入至少 2 個字元後再搜尋"};let t=e.query.trim(),a=e.limit||10,{data:r,error:l}=await s.O.from("customer_personal_data").select("id, customer_id, customer_name, phone").or("customer_name.ilike.%".concat(t,"%,phone.ilike.%").concat(t,"%,customer_id.ilike.%").concat(t,"%")).order("created_at",{ascending:!1}).limit(a);if(l)throw l;return{data:(r||[]).map(e=>({id:e.id,customer_id:e.customer_id,customer_name:e.customer_name,phone:e.phone,display_text:"".concat(e.customer_name," - ").concat(e.phone).concat(e.customer_id?" - ".concat(e.customer_id):" - 未分配編號")}))}}catch(e){return{data:[],error:"搜尋建議載入失敗",message:e.message}}}static async getCustomers(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;try{let r=s.O.from("customer_personal_data").select("\n          id,\n          customer_id,\n          customer_name,\n          phone,\n          district,\n          service_address,\n          project_manager,\n          created_at,\n          customer_type,\n          voucher_application_status,\n          lds_status,\n          home_visit_status,\n          copay_level\n        ",{count:"exact"});(null==e?void 0:e.customer_type)&&(r=r.eq("customer_type",e.customer_type)),(null==e?void 0:e.district)&&(r=r.eq("district",e.district)),(null==e?void 0:e.introducer)&&(r=r.eq("introducer",e.introducer)),(null==e?void 0:e.project_manager)&&(r=r.eq("project_manager",e.project_manager)),(null==e?void 0:e.search)&&(r=r.or("customer_name.ilike.%".concat(e.search,"%,phone.ilike.%").concat(e.search,"%,customer_id.ilike.%").concat(e.search,"%")));let l=(t-1)*a;r=(r=r.range(l,l+a-1)).order("created_at",{ascending:!1});let{data:i,error:o,count:n}=await r;if(o)throw o;return{data:i||[],count:n||0,page:t,pageSize:a,totalPages:Math.ceil((n||0)/a)}}catch(e){return console.error("獲取客戶列表失敗:",e),{data:[],count:0,page:t,pageSize:a,totalPages:0}}}static async getCustomerById(e){try{console.log("Fetching customer with ID:",e);let{data:t,error:a}=await this.queryBySmartId(e,(t,a)=>t.select("*").eq(a,e).single());if(a&&"PGRST116"===a.code){console.log("First query failed, trying alternative method...");let t=this.isUUID(e),a=await s.O.from("customer_personal_data").select("*").eq(t?"customer_id":"id",e).single();if(a.error)throw console.error("Database error:",a.error),a.error;return console.log("Customer data found via alternative method:",a.data),{data:a.data||void 0}}if(a)throw console.error("Database error:",a),a;return console.log("Customer data found:",t),{data:t||void 0}}catch(e){return console.error("Service error:",e),{error:"客戶資料載入失敗",message:e.message}}}static async createCustomer(e){try{let t=await this.generateNextCustomerId(e.customer_type,e.introducer),a={customer_id:t,customer_type:e.customer_type,customer_name:e.customer_name,service_address:e.service_address,charity_support:e.charity_support||!1,phone:e.phone||null,hkid:e.hkid||null,dob:e.dob||null,age:e.age||null,district:e.district||null,health_status:e.health_status||null,introducer:e.introducer||null,voucher_application_status:e.voucher_application_status||null,lds_status:e.lds_status||null,home_visit_status:e.home_visit_status||null,project_manager:e.staff_owner||null,copay_level:e.copay_level||null,voucher_number:e.voucher_number||null,created_at:new Date().toISOString()},{error:r}=await s.O.from("customer_personal_data").insert([a]);if(r)throw console.error("Supabase 插入錯誤:",r),Error(r.message);return{success:!0,customer_id:t}}catch(e){return console.error("新增客戶失敗:",e),{success:!1,error:e.message||"新增客戶失敗"}}}static async updateCustomer(e,t){try{if(t.dob){let e=new Date(t.dob),a=new Date;t.age=a.getFullYear()-e.getFullYear();let s=a.getMonth()-e.getMonth();(s<0||0===s&&a.getDate()<e.getDate())&&t.age--}let a=await this.queryBySmartId(e,(a,s)=>a.update(t).eq(s,e).select().single());if(a.error)throw a.error;return{data:a.data||void 0}}catch(e){return{error:"客戶資料更新失敗",message:e.message}}}static async deleteCustomer(e){try{let t=await this.queryBySmartId(e,(t,a)=>t.delete().eq(a,e));if(t.error)throw t.error;return{}}catch(e){return{error:"客戶刪除失敗",message:e.message}}}static validateCustomerData(e){var t,a,s,r,l,i,o,n,c,d,u;let p={};return(null===(t=e.customer_name)||void 0===t?void 0:t.trim())||(p.customer_name="客戶姓名為必填欄位"),(null===(a=e.phone)||void 0===a?void 0:a.trim())||(p.phone="電話為必填欄位"),(null===(s=e.district)||void 0===s?void 0:s.trim())||(p.district="地區為必填欄位"),(null===(r=e.service_address)||void 0===r?void 0:r.trim())||(p.service_address="服務地址為必填欄位"),(null===(l=e.hkid)||void 0===l?void 0:l.trim())||(p.hkid="身份證號碼為必填欄位"),(null===(i=e.dob)||void 0===i?void 0:i.trim())||(p.dob="出生日期為必填欄位"),(null===(o=e.health_status)||void 0===o?void 0:o.trim())||(p.health_status="身體狀況為必填欄位"),(null===(n=e.introducer)||void 0===n?void 0:n.trim())||(p.introducer="介紹人為必填欄位"),(null===(c=e.project_manager)||void 0===c?void 0:c.trim())||(p.project_manager="項目經理為必填欄位"),e.phone&&!/^[0-9]{8}$/.test(e.phone)&&(p.phone="電話格式錯誤，請輸入 8 位數字"),e.hkid&&!/^[A-Z]{1,2}[0-9]{6}([0-9A])$/.test(e.hkid)&&(p.hkid="HKID 格式錯誤"),e.dob&&new Date(e.dob)>new Date&&(p.dob="出生日期不能是未來日期"),"已經持有"!==e.voucher_application_status||((null===(d=e.voucher_number)||void 0===d?void 0:d.trim())||(p.voucher_number="voucher_number：只有 voucher_application_status=已經持有 時必填"),(null===(u=e.copay_level)||void 0===u?void 0:u.trim())||(p.copay_level="請選擇自付比例（copay_level）")),"5%"===e.copay_level&&void 0===e.charity_support&&(p.charity_support="copay_level 為 5% 時，必須選擇慈善資助（charity_support）"),{isValid:0===Object.keys(p).length,errors:p}}}}},function(e){e.O(0,[998,971,117,744],function(){return e(e.s=5753)}),_N_E=e.O()}]);